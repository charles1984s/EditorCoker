function PageReady(){let e,a,o=null,t=0,n=[];const c=$("#MemberData").html(),s=$("#RoleData").html(),r=$("#PowerData").html(),i=function(){co.PowerManagement.GetAll().done((function(e){const t=$("#offcanvas1").data("init",e.jobs),c=t.find("#Permissions");t.find(".siteName").text(e.title),d(c,e.jobs),$("#offcanvas1 .selectedItem").off("change.save").on("change.save",(function(){const e={name:$(this).data("name"),IsGranted:$(this).prop("checked")};co.Array.Search(n,{name:e.name})>-1?co.Array.Delete(n,{name:e.name}):n.push(e)})),$("#offcanvas1 .save").off("click").on("click",(function(){const e={Items:n};e[a]=$(o).data("id"),co.PowerManagement.SavePermissions(e).done((function(e){e.success?co.sweet.success("儲存成功"):co.sweet.error("儲存失敗",e.error)}))}))}))},d=function(e,a){$(a).each(((a,o)=>{if(o.enable){const a=$(r);a.find(".title").text(o.title);const t=a.find("#new");a.find("#new+label").attr({for:`${o.pageName}_new`}),t.attr({id:`${o.pageName}_new`,name:`${o.pageName}_new`}).data({name:`${o.pageName}.Create`}).prop("checked",o.canCreate);const n=a.find("#del");a.find("#del+label").attr({for:`${o.pageName}_del`}),n.attr({id:`${o.pageName}_del`,name:`${o.pageName}_del`}).data({name:`${o.pageName}.Delete`}).prop("checked",o.canRemove);const c=a.find("#edit");a.find("#edit+label").attr({for:`${o.pageName}_edit`}),c.attr({id:`${o.pageName}_edit`,name:`${o.pageName}_edit`}).data({name:`${o.pageName}.Edit`}).prop("checked",o.canUpdate);const s=a.find("#view");a.find("#view+label").attr({for:`${o.pageName}_view`}),s.attr({id:`${o.pageName}_view`,name:`${o.pageName}_view`}).data({name:`${o.pageName}.View`}).prop("checked",o.canVisble),s.on("change",(function(){$(this).prop("checked")||(c.prop("checked")&&c.prop("checked",!1).trigger("change"),n.prop("checked")&&n.prop("checked",!1).trigger("change"),t.prop("checked")&&t.prop("checked",!1).trigger("change"))})),a.appendTo(e),null!=o.jobItemModels&&o.jobItemModels.length>0&&d(a,o.jobItemModels)}}))},m=function(e){$(e).each((function(){f(this),null!=this.jobItemModels&&m(this.jobItemModels)}))},f=function(e){$(`[name="${e.pageName}_new"]`).prop("checked",e.canCreate),$(`[name="${e.pageName}_del"]`).prop("checked",e.canRemove),$(`[name="${e.pageName}_edit"]`).prop("checked",e.canUpdate),$(`[name="${e.pageName}_view"]`).prop("checked",e.canVisble)},l=function(){const e=$(this),a=e.data();$(".powerctrl .role-item").removeClass("roleChecked"),e.addClass("roleChecked"),$("#roleMember").data(a),h()},p=function(){var e=$("#noGroupMember").data("members");$("#noGroupMember").empty(),$(e).each((function(){u("#noGroupMember",this)}))},h=function(){var e=$("#roleMember").data("members");$("#roleMember").empty(),$(e).each((function(){u("#roleMember",this)}))},u=function(e,t){const n=$(c).data(t);n.find(".title").text(t.name),n.on("click",(function(e){e.stopPropagation(),$(this).hasClass("checked")?$(this).removeClass("checked"):$(this).addClass("checked")})),n.find(".fa-trash-alt").on("click",(function(e){e.stopPropagation();const a=$(this).closest(".item"),o=`是否確認刪除使用者<span class="ConfirmDanger">${$(a).text()}</span>`,t=$(this).closest(".card-content");co.sweet.confirm("確認刪除?",o,"確認","取消",(function(){co.PowerManagement.RemoveMappingUserAndWebsite($(a).data("id")).done((e=>{if(e.success)if(co.sweet.success("已刪除授權"),"noGroupMember"==$(t).attr("id")){var o=$("#noGroupMember").data("members");co.Array.Delete(o,$(a).data()),$("#noGroupMember").data("members",o),p(),$(".offcanvas").offcanvas("hide")}else{o=$("#roleMember").data("members");co.Array.Delete(o,$(a).data()),$("#roleMember").data("members",o),h(),$(".offcanvas").offcanvas("hide")}else co.sweet.error(e.error)}))}))})),n.find(".fa-edit").on("click",(function(e){e.stopPropagation();const a=$(this).parents(".member-item").first();o=a,co.PowerManagement.GetUser(a.data("id")).done((e=>{if(e.success){var a=$("#offcanvastopByMember form");co.Form.insertData(e.data,a)}else co.sweet.error("資料錯誤",e.error)}))})),n.find(".fa-user-cog").on("click",(function(e){e.stopPropagation();const t=$(this).parents(".member-item").first();o=t,a="FK_UserId"})),n.appendTo(e)},g=function(e){const t=$(s).data(e);t.find(".title").text(e.name),t.on("click",l),t.find(".fa-trash-alt").on("click",(function(e){e.stopPropagation();const a=$(this).closest(".item"),o=`是否確認刪除角色<span class="rad">${$(a).text()}</span>`;co.sweet.confirm("確認刪除?",o,"確認","取消",(function(){co.PowerManagement.DeleteRole($(a).data("id")).done((e=>{e.success?(co.sweet.success("已刪除角色"),$(a).remove()):co.sweet.error(e.error)}))}))})),t.find(".fa-edit").on("click",(function(e){e.stopPropagation();const a=$(this).closest(".item");o=a,co.Form.insertData($(a).data(),$("#offcanvastopByRoleEdit"))})),t.find(".fa-user-cog").on("click",(function(e){e.stopPropagation();const t=$(this).parents(".role-item").first();o=t,a="FK_RoleId"})),t.appendTo("#RoleList")};co.PowerManagement.getAllUsers().done((a=>{a.success&&(e=a.data,$(e).each((function(e,a){0!=a.id?g(a):($("#noGroupMember").data(a),p())})),$(".powerctrl .role-item").first().trigger("click"),i(),co.Zipcode.init("#TWzipcode"),co.Zipcode.init("#new-TWzipcode"))})),$("#right-btn").on("click",(function(){const e=$("#roleMember .member-item.checked"),a=$("#RoleList .role-item.roleChecked");if(e.length>0){const o=[],t=[];e.each((function(){o.push($(this).data("id")),t.push(this)})),co.PowerManagement.RemoveUserToRole({Users:o,RoleId:a.data("id")}).done((e=>{e.success&&$(t).each((function(){co.Array.Delete(a.data("members"),$(this).data()),$(this).appendTo("#noGroupMember"),$(this).removeClass("checked")}))}))}else co.sweet.error("請選擇要退出群組的使用者")})),$("#left-btn").on("click",(function(){const e=$("#noGroupMember .member-item.checked"),a=$("#RoleList .role-item.roleChecked");if(e.length<=0)co.sweet.error("加入失敗","請選擇要加入角色的使用者");else if(a.length<=0)co.sweet.error("加入失敗","請選擇或新增使用者要加入的角色");else{const o=[],t=[];e.each((function(){o.push($(this).data("id")),t.push(this)})),co.PowerManagement.AddUserToRole({Users:o,RoleId:a.data("id")}).done((e=>{e.success&&$(t).each((function(){a.data("members").push($(this).data()),$(this).appendTo("#roleMember"),$(this).removeClass("checked")}))}))}})),$("#offcanvastopByMember .cancel").on("click",(()=>{$(".offcanvas").offcanvas("hide")})),$("#offcanvastopByMember .delete").on("click",(()=>{$(o).find(".fa-trash-alt").trigger("click")})),$("#offcanvastopByMember .submit").on("click",(()=>{$(".offcanvas").offcanvas("hide")})),$("#offcanvastopByAddUser .submit").on("click",(()=>{const e=$('#offcanvastopByAddUser [name="email"]').val();""==e.trim()?co.sweet.error("請輸入要加入管理的使用者帳號或電子信箱"):co.PowerManagement.MappingUserAndWebsite({emailOrAccount:e,RoleId:t}).done((e=>{if(e.success){var a,o=JSON.parse(e.message);if($(".offcanvas").offcanvas("hide"),0==t)(a=$("#noGroupMember").data()).members.unshift({id:o.Id,name:o.Name}),$("#noGroupMember").data("members",a.members),p(),$("#noGroupMember .item:first-child").trigger("click");else(a=$("#roleMember").data()).members.unshift({id:o.Id,name:o.Name}),$("#roleMember").data("members",a.members),h(),$("#roleMember .item:first-child").trigger("click")}else co.sweet.error("新增失敗",e.error)}))})),co.Form.init("offcanvastopByNewMemberForm",(e=>{const a=co.Form.getJson(e),o=document.getElementById("password"),t=e=>{o.setCustomValidity(e),$("#password ~ .invalid-feedback").text(e),$("#PasswordConfirm").val("")};a.password.length<8||password>30?t("密碼長度需在8~30個字元"):a.password!=a.PasswordConfirm?t("密碼與密碼驗證不相符"):co.PowerManagement.AddUser(a).done((function(e){e.success?($('#offcanvastopByAddUser [name="email"]').val(a.account),$("#offcanvastopByAddUser .submit").trigger("click")):(e.error.indexOf("密碼")>-1&&($("#password").val(""),t(e.error)),co.sweet.error("帳號新增失敗",e.error))}))})),$("#offcanvastopByRole .submit").on("click",(()=>{const e=$('#offcanvastopByRole [name="name"]').val();""==e.trim()?co.sweet.error("角色名稱不可為空"):co.PowerManagement.AddRole({Name:e}).done((function(e){if(e.success){var a=JSON.parse(e.message);$(".offcanvas").offcanvas("hide"),g({id:a.Id,name:a.Name,members:[]}),$("#RoleList .item:last-child").trigger("click")}else co.sweet.error("新增失敗",e.error)}))})),$("#offcanvastopByRoleEdit .submit").on("click",(()=>{if(""==$('#offcanvastopByRoleEdit [name="name"]').val().trim())co.sweet.error("角色名稱不可為空");else{const e=co.Form.getJson("offcanvastopByRoleEditForm");co.PowerManagement.EditRole(e).done((function(a){a.success?($(".offcanvas").offcanvas("hide"),$(o).find(".title").text(e.name),$(o).data(e),co.sweet.success("修改成功")):co.sweet.error("修改失敗",a.error)}))}})),$("#addUserInRole").on("click",(()=>{0==$("#RoleList .roleChecked").length?(co.sweet.error("請選擇欲讓使用者加入的角色"),$(".offcanvas").offcanvas("hide")):($("#offcanvastopByAddUserSelect").offcanvas("show"),t=$("#RoleList .roleChecked").data("id"))})),$("#offcanvas1").on("shown.bs.offcanvas",(function(){n.length=0,m($("#offcanvas1").data("init"));const e={};e[a]=$(o).data("id"),$("#offcanvas1 .data>.type").text(a.indexOf("Role")>0?"角色":"使用者"),$("#offcanvas1 .data>.name").text($(o).data("name")),co.PowerManagement.GetPermissions(e).done((function(e){e.success?function(e){$(e).each((function(){const e=this,a=e.name.split(".");switch(a[1]){case"Edit":$(`[name="${a[0]}_edit"]`).prop("checked",e.isGranted);break;case"Delete":$(`[name="${a[0]}_del"]`).prop("checked",e.isGranted);break;case"Create":$(`[name="${a[0]}_new"]`).prop("checked",e.isGranted);break;case"View":$(`[name="${a[0]}_view"]`).prop("checked",e.isGranted)}}))}(e.items):co.sweet.error("權限抓取失敗",e.error)}))})),$("#offcanvastopByNewMember").on("show.bs.offcanvas",(function(){$("#offcanvastopByNewMember form").get(0).reset()})),$("#addUser").on("click",(()=>{t=0}))}