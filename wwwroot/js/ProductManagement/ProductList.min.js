var $btn_display,$name,$name_count,$introduction,$introduction_count,$illustrate,$illustrate_count,$marks,$tag,$price,$stock_number,$alert_number,$min_number,$date,$picker,$permanent,startDate,endDate,keyId,product_list,$price_modal,priceModal,disp_opt=!0,spec_num=0,spec_price_num=0,spec_remove_list=[],spec_price_remove_list=[],modal_price_list=[],techcert_list=[];function PageReady(){co.Product={AddUp:{Product:function(t){return $.ajax({url:"/api/Product/ProductAddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(t),dataType:"json"})},Stock:function(t){return $.ajax({url:"/api/Product/StockAddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(t),dataType:"json"})},ProdTechCert:function(t){return $.ajax({url:"/api/Product/TechCertAddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(t),dataType:"json"})}},GetAll:{TechCert:function(){return $.ajax({url:"/api/TechnicalCertificate/GetAll/",type:"GET"})}},Get:{ProdOne:function(t){return $.ajax({url:"/api/Product/GetProdDataOne/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{id:t}})},ProdStock:function(t){return $.ajax({url:"/api/Product/GetStockDataAll/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{PId:t}})},ProdSpec:function(t){return $.ajax({url:"/api/Product/GetSpecDetail/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{typeid:t}})},ProdTechCert:function(t){return $.ajax({url:"/api/Product/GetTechCertDataAll/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{PId:t}})}},Delect:{Prod:function(t){return $.ajax({url:"/api/Product/ProdDelete",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(t),dataType:"json"})},Stock:function(t){return $.ajax({url:"/api/Product/StockDelete",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(t),dataType:"json"})}}},ElementInit(),$picker=$("#InputDate"),co.Picker.Init($picker),$picker.on("apply.daterangepicker",(function(t,e){$(this).val(e.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+e.endDate.format("YYYY/MM/DD HH:mm")),startDate=e.startDate.format(""),endDate=e.endDate.format("")}));const t=$("#ProductForm");Array.from(t).forEach((t=>{t.addEventListener("submit",(e=>{t.checkValidity()?(e.preventDefault(),ISpecRepect()?co.sweet.error("錯誤","商品規格不可重複",null,!1):Coker.sweet.confirm("即將發布","發布後將直接顯示於安排的位置","發布","取消",(function(){AddUp(disp_opt,"已成功發布","發布發生未知錯誤")}))):(e.preventDefault(),e.stopPropagation()),t.classList.add("was-validated")}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回商品列表","資料將不被保存","確定","取消",(function(){history.back()}))})),$(".btn_add").on("click",(function(){window.location.hash=0,HashDataEdit()})),$(".btn_input_pic").on("click",(function(t){t.preventDefault(),$(".input_pic").click()})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$(".btn_expand_out").on("click",(function(){var t=$(this);"expand_more"==t.children("span").text()?t.children("span").text("expand_less"):t.children("span").text("expand_more")})),$(".btn_spec_add").on("click",SpecAdd),$(".btn_spec_price_add").on("click",SpecPriceAdd),$(".btn_price_save").on("click",SpecPriceSave),$name.on("keyup",(function(){$name_count.text($name.val().length)})),$introduction.on("keyup",(function(){$introduction_count.text($introduction.val().length)})),$illustrate.on("keyup",(function(){$illustrate_count.text($illustrate.val().length)})),$permanent.on("click",(function(){$permanent.is(":checked")?($date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null):$date.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3),$(".markstest > button > .mark_display").text("哈哈測試耶耶耶"),co.Product.GetAll.TechCert().done((function(t){t.length>0&&($techcert_body.children(".isnull").addClass("d-none"),t.forEach((function(t){var e=$($("#TemplateCheck").html()).clone(),n=e.find("input"),a=e.find("label");n.attr("id","TechCertCheck"+t.id),n.val(t.id),a.attr("for","TechCertCheck"+t.id),a.text(t.title),$techcert_body.append(e)})))})),$(".btn_techcert_save").on("click",(function(){if($techcert_body.children("div[class=form-check]").length>0){var t="";$techcert_body.children("div[class=form-check]").each((function(){var e=$(this);e.children("input").prop("checked")&&(techcert_list.push(e.children("input").val()),t=""==t?e.children("label").text():t+"、"+e.children("label").text(),techcertModal.hide(),$marks.val(t))}))}}))}function ElementInit(){$btn_display=$("#Btn_Display"),$name=$("#InputName"),$name_count=$("#ProductForm > .name .name_count"),$introduction=$("#InputIntroduction"),$introduction_count=$("#ProductForm > .introduction .introduction_count"),$illustrate=$("#InputIllustrate"),$illustrate_count=$("#ProductForm > .illustrate .illustrate_count"),$marks=$("#InputMarks"),$tag=$("#InputTag"),$spec_select=$(".spec_select"),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$date=$("#InputDate"),$permanent=$("#PermanentCheck"),techcertModal=new bootstrap.Modal(document.getElementById("TechCertModal")),$techcert_body=$("#TechCertModal > .modal-dialog > .modal-content > .modal-body"),priceModal=new bootstrap.Modal(document.getElementById("PriceModal")),$price_modal=$("#PriceModal >.modal-dialog > .modal-content > .modal-body >.price_option"),document.getElementById("PriceModal").addEventListener("hidden.bs.modal",(function(t){$price_modal.children(".frame").each((function(){$(this).remove(),modal_price_list=[],spec_price_num=0}))}))}function FormDataClear(){$("#Spec_Frame > .frame").each((function(){$(this).remove()})),spec_num=0,keyId=0,$btn_display.children("span").text("visibility"),disp_opt=!0,$name.val(""),$name_count.text(0),$introduction.val(""),$introduction_count.text(0),$illustrate.val(""),$illustrate_count.text(0),$marks.val(""),$tag.val(""),$price.val(""),$stock_number.val(""),$alert_number.val(""),$min_number.val(""),$permanent.prop("checked",!1),$date.val(""),$date.removeAttr("disabled"),startDate=null,endDate=null,spec_remove_list=[],techcert_list=[],$techcert_body.children("div[class=form-check]").each((function(){$(this).children("input").prop("checked",!1)}))}function contentReady(t){product_list=t,HashDataEdit()}function hashChange(t){t?(HashDataEdit(),t.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var t=window.location.hash.replace("#","");0==parseInt(t)?(FormDataClear(),SpecAdd(null),MoveToContent()):co.Product.Get.ProdOne(parseInt(t)).done((function(t){null!=t?(FormDataSet(t),MoveToContent()):window.location.hash=""}))}}else BackToList()}function editButtonClicked(t){MoveToContent(),keyId=t.row.key,window.location.hash=keyId}function FormDataSet(t){FormDataClear(),co.Product.Get.ProdStock(t.id).done((function(t){t.forEach((function(t){SpecAdd(t)}))})),startDate=t.startTime,endDate=t.endTime,keyId=t.id,disp_opt=t.disp_Opt,$btn_display.children("span").text(t.disp_Opt?"visibility":"visibility_off"),$name.val(t.title),$name_count.text($name.val().length),$introduction.val(t.introduction),$introduction_count.text($introduction.val().length),$illustrate.val(t.description),$illustrate_count.text($illustrate.val().length);var e="";co.Product.Get.ProdTechCert(t.id).done((function(t){null!=t&&t.length>0&&t.forEach((function(t){techcert_list.push(t.id),$techcert_body.children("div[class=form-check]").each((function(){var e=$(this).children("input");e.val()==t.id&&e.prop("checked",!0)})),e=""==e?t.title:e+"、"+t.title})),$marks.val(e)})),$tag.val(""),$date=$("#InputDate"),t.permanent?($date.val(""),$date.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate))}function deleteButtonClicked(t){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Product.Delect.Prod({Id:t.row.key,TId:$.cookie("secret")}).done((function(){product_list.component.refresh()})).fail((function(){Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)}))}))}function SpecPriceAdd(t){spec_price_num+=1;var e=$($("#ModalTemplatePrice").html()).clone();e.find(".select_role"),e.find(".input_cash"),e.find(".input_bonus");e.find(".btn_price_delect").on("click",(function(){$self_p=$(this).parents(".frame").first(),1==spec_price_num?co.sweet.error("商品至少需有一種價格",null,!1):co.sweet.confirm("移除價格","確定要移除此項價格嗎?","　是　","　否　",(function(){spec_price_remove_list.push($self_p.data("ppid")),spec_price_num-=1,$self_p.remove()}))})),$("#PriceModal > .modal-dialog > .modal-content > .modal-body > .price_option").append(e),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function SpecPriceSave(){var t=!0,e=[];modal_price_list=[],$price_modal.children(".frame").each((function(){return $self=$(this),e.PSid=$self.find(".select_role").val(),e.Rid=$self.find(".select_role").val(),e.Price=$self.find(".input_cash").val(),e.Bonus=$self.find(".input_bonus").val(),""==e.Price&&""==e.Bonus?(co.sweet.error("錯誤","商品現金與紅利不可同時為空",null,!1),t=!1,!1):null!=modal_price_list.find((t=>t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]))?(co.sweet.error("錯誤","價格不可重複",null,!1),t=!1,!1):(modal_price_list.push(e),void(e=[]))})),t&&priceModal.hide()}function SpecAdd(t){spec_num+=1;var e=$($("#TemplateSpecification").html()).clone(),n=e.find(".topline"),a=e.find(".input_spec").first(),i=e.find(".input_spec").last(),c=e.find("datalist").first(),o=e.find("datalist").last(),r=e.find(".input_price"),l=e.find(".input_min_number"),d=e.find(".input_stock_number"),s=e.find(".input_alert_number"),p=e.find(".collapse"),u=e.find(".btn_expand"),_=e.find(".btn_delect");n.children(".spec").each((function(){var t=$($("#TemplateSpecType").html()).clone();$(this).prepend(t)}));var h=e.find(".spec_select").first(),f=e.find(".spec_select").last();null!=t&&null!=t.fK_ST1id&&(h.val(t.fK_ST1id),t.fK_ST1id>0&&(h.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var t=$(this);t.val()==h.val()&&(t.attr("disabled","disabled"),t.addClass("bg-secondary-light25"))})),a.removeAttr("disabled"),co.Product.Get.ProdSpec(h.val()).done((function(e){null!=e&&e.forEach((function(e){c.append('<option value="'+e.title+'" data-sid="'+e.id+'"></option>'),e.id==t.fK_S1id&&a.val(e.title)}))}))));null!=t&&null!=t.fK_ST2id&&(f.val(t.fK_ST2id),t.fK_ST2id>0&&(f.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var t=$(this);t.val()==f.val()&&(t.attr("disabled","disabled"),t.addClass("bg-secondary-light25"))})),i.removeAttr("disabled"),co.Product.Get.ProdSpec(f.val()).done((function(e){null!=e&&e.forEach((function(e){o.append('<option value="'+e.title+'" data-sid="'+e.id+'"></option>'),e.id==t.fK_S2id&&i.val(e.title)}))}))));e.data("psid",null!=t?t.id:""),r.val(null!=t?t.price:""),l.val(null!=t?t.min_Qty:""),d.val(null!=t?t.stock:""),s.val(""),s.val(null!=t?t.alert_Qty:""),p.attr("id","CollapseDetail"+spec_num),u.attr("data-bs-target","#CollapseDetail"+spec_num),u.attr("aria-controls","CollapseDetail"+spec_num),a.attr("list","SpecListOpt"+spec_num+"-1"),i.attr("list","SpecListOpt"+spec_num+"-2"),c.attr("id","SpecListOpt"+spec_num+"-1"),o.attr("id","SpecListOpt"+spec_num+"-2"),u.on("click",(function(){var t=$(this);"expand_more"==t.children("span").text()?t.children("span").text("expand_less"):t.children("span").text("expand_more")})),_.on("click",(function(){$self_p=$(this).parents(".frame").first(),1==spec_num?co.sweet.error("商品至少需有一種規格",null,!1):co.sweet.confirm("移除規格","確定要移除此項規格嗎?","　是　","　否　",(function(){spec_remove_list.push($self_p.data("psid")),spec_num-=1,$self_p.remove()}))})),$("#Spec_Frame").append(e),$spec_select=$(".spec_select"),$spec_select.each((function(){$self=$(this),$self.on("change",(function(){var t=$(this),e=t.parents(".spec").first().siblings(".spec"),n=t.siblings(".input_spec"),a=t.siblings("datalist");n.val(""),a.children("option").each((function(){$(this).remove()})),e.children(".spec_select").children("option").each((function(){var t=$(this);t.removeAttr("disabled"),t.removeClass("bg-secondary-light25")})),0==t.val()?n.attr("disabled","disabled"):(e.children(".spec_select").children("option").each((function(){var e=$(this);e.val()==t.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),n.removeAttr("disabled"),co.Product.Get.ProdSpec(t.val()).done((function(t){null!=t&&t.forEach((function(t){a.append('<option value="'+t.title+'" data-sid="'+t.id+'"></option>')}))})))}))})),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function ISpecRepect(){var t=[],e=[],n=!1;return $("#Spec_Frame > .frame").each((function(){$self=$(this),$self.find(".input_spec").each((function(){t.push($(this).val())})),null!=e.find((e=>e[0]==t[0]&&e[1]==t[1]))?n=!0:(e.push(t),t=[])})),n}function AddUp(t,e,n){spec_remove_list.length>0&&spec_remove_list.forEach((function(t){co.Product.Delect.Stock({Id:t,TId:$.cookie("secret")})})),co.Product.AddUp.Product({TId:$.cookie("secret"),Id:keyId,Title:$name.val(),Disp_Opt:t,Ser_No:500,Introduction:$introduction.val(),Description:$illustrate.val(),StartTime:startDate,EndTime:endDate,Permanent:$permanent.is(":checked")}).done((function(t){t.success?(keyId=null==t.message?keyId:t.message,$("#Spec_Frame > .frame").each((function(){var t=[],a=$(this);a.find(".input_spec").each((function(){var e=-1;$self_input=$(this),$self_input.siblings("datalist").children("option").each((function(){var t=$(this);t.val()==$self_input.val()&&(e=t.data("sid"))})),t.push(e>-1?e:0)})),co.Product.AddUp.Stock({TId:$.cookie("secret"),Id:""==a.data("psid")?0:a.data("psid"),Pid:keyId,FK_S1id:t[0],FK_S2id:t[1],Price:a.find(".input_price").val(),Stock:a.find(".input_stock_number").val(),Min_Qty:a.find(".input_min_number").val(),Alert_Qty:a.find(".input_alert_number").val()}).done((function(){null!=techcert_list&&techcert_list.forEach((function(t){co.Product.AddUp.ProdTechCert({Id:0,FK_PId:keyId,FK_TCId:t})})),Coker.sweet.success(e,null,!0),setTimeout((function(){BackToList(),product_list.component.refresh()}),1e3)})).fail((function(){Coker.sweet.error("錯誤",n,null,!0)}))}))):Coker.sweet.error("錯誤",n,null,!0)})).fail((function(){Coker.sweet.error("錯誤",n,null,!0)}))}function MoveToContent(){$("#ProductForm").removeClass("was-validated"),$("#ProductList").addClass("d-none"),$("#ProductContent").removeClass("d-none")}function BackToList(){$("#ProductList").removeClass("d-none"),$("#ProductContent").addClass("d-none"),window.location.hash=""}