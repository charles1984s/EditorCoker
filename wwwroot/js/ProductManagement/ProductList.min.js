var $display,$removedFromShelves,$name,$name_count,$introduction,$introduction_count,$illustrate,$illustrate_count,$marks,$price,$subItemNo,$stock_number,$alert_number,$min_number,$date,$picker,$permanent,$itemNo,$itemNo_count,startDate,endDate,keyId,price_tid,temp_psid,product_list,spec_pick_list,$price_modal,priceModal,spec_num=0,spec_price_num=0,spec_remove_list=[],modal_price_list=[],total_files=[];let importProdPopup=null;function ImportProd(){var e=new FormData($('[name="fileUploadForm"]')[0]);co.Product.AddUp.Import(e).done((function(e){importProdPopup.hide(),co.sweet.success("檔案上傳成功"),null!=product_list&&product_list.component.refresh()})).fail((function(){co.sweet.error("檔案格式錯誤，無法解讀。")}))}function showImportProdPopup(){importProdPopup=$("#importProdPopup").dxPopup("instance"),importProdPopup.option("contentTemplate",$("#importProdPopup-template")),importProdPopup.option("title","商品匯入"),importProdPopup.show()}function toolbarPreparing(e){e.component;e.toolbarOptions.items.unshift({location:"after",widget:"dxButton",options:{icon:"fa-solid fa-file-excel",text:"商品匯入",onClick:showImportProdPopup}})}function PageReady(){ElementInit(),TechCertListModalInit(),TagListModalInit();const e=grapesInit({save:function(e,t){var a=$.Deferred();return co.Product.Content.SaveConten({Id:$("#gjs").data("id"),SaveHtml:e,SaveCss:t}).done((function(e){e.success?a.resolve():co.sweet.error(e.error)})),a.promise()},import:function(e,t){var a=$.Deferred();return co.Product.Content.ImportConten({Id:$("#gjs").data("id"),SaveHtml:e,SaveCss:t}).done((function(e){e.success?a.resolve():co.sweet.error(e.error)})),a.promise()},getComponer:function(){var e=$.Deferred();return co.HtmlContent.GetAllComponent().done((function(t){t.success?e.resolve(t.list):co.sweet.error(resutlt.error)})),e.promise()}});setPage=function(t){co.Product.Content.GetConten({Id:t}).done((function(a){if(a.success){var n=co.Data.HtmlDecode(a.conten.saveHtml);co.Grapes.setEditor(e,n,a.conten.saveCss),co.Grapes.setFile(e,t,3)}else co.sweet.error(a.error)}))},co.File.ListFileInit(),co.Product.Spec.ListInit(),$picker=$("#InputDate"),co.Picker.Init($picker),$picker.on("apply.daterangepicker",(function(e,t){$(this).val(t.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+t.endDate.format("YYYY/MM/DD HH:mm")),startDate=t.startDate.format(""),endDate=t.endDate.format("")})),$(document).on("wheel","input[type=number]",(function(e){e.preventDefault()})),$(document).on("blur",'input[type="number"]',(function(){var e=$(this),t=e.val().trim();/^0+\d/.test(t)&&(t=t.replace(/^0+/,"")),"1"==e.attr("step")&&t.includes(".")&&(t=t.substring(0,t.indexOf("."))),parseFloat(t)>1e8&&(t="100000000"),e.val(t)}));const t=$("#ProductForm");Array.from(t).forEach((e=>{e.addEventListener("submit",(t=>{if(e.checkValidity())if(t.preventDefault(),ISpecRepect())co.sweet.error("錯誤","商品規格不可重複",null,!1);else{var a,n=!1;$(".input_price").each((function(){if(""==$(this).val())return n=!0,a=$(this),!1})),n?co.sweet.error("錯誤","請確實填寫價格",(function(){setTimeout((function(){$("html, body").animate({scrollTop:a.offset().top-2*$("header").height()},0)}),500)}),!1):Coker.sweet.confirm("即將發布","發布後將直接顯示於安排的位置","發布","取消",(function(){AddUp("已成功發布","發布發生未知錯誤","item")}))}else t.preventDefault(),t.stopPropagation();e.classList.add("was-validated")}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回商品列表","資料將不被保存","確定","取消",(function(){BackToList(!0)}))})),$(".btn_add").on("click",(function(){window.location.hash=0})),$(".btn_input_pic").on("click",(function(e){e.preventDefault(),$(".input_pic").click()})),$(".btn_expand_out").on("click",(function(){var e=$(this);"expand_less"==e.children("span").text()?e.children("span").text("expand_more"):e.children("span").text("expand_less")})),$(".btn_spec_price_add").on("click",(function(){SpecPriceAdd(null)})),$(".btn_price_save").on("click",SpecPriceSave),$name.on("keyup",(function(){$name_count.text($name.val().length)})),$introduction.on("keyup",(function(){$introduction_count.text($introduction.val().length)})),$illustrate.on("keyup",(function(){$illustrate_count.text($illustrate.val().length)})),$permanent.on("click",(function(){$permanent.is(":checked")?($date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null):$date.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3),$(".btn_to_canvas").on("click",(function(e){e.preventDefault(),Swal.fire({icon:"info",title:"前往內容編輯頁",html:"是否保存資料?",showCancelButton:!0,showDenyButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#888888",denyButtonColor:"#d33",confirmButtonText:"　是　",cancelButtonText:"　取消　",denyButtonText:"　否　",reverseButtons:!0}).then((e=>{e.isConfirmed?Array.from(t).forEach((e=>{if(e.checkValidity())if(ISpecRepect())$removedFromShelves.is(":checked")?($removedFromShelves.prop("checked",!1),AddUp("已成功儲存，資料尚有缺漏或格式錯誤，未上架","儲存發生未知錯誤","Canvas")):AddUp("已成功儲存","儲存發生未知錯誤","Canvas");else{var t=!1;$(".input_price").each((function(){if(""==$(this).val())return t=!0,$(this),!1})),t?$removedFromShelves.is(":checked")?($removedFromShelves.prop("checked",!1),AddUp("已成功儲存，資料尚有缺漏或格式錯誤，未上架","儲存發生未知錯誤","Canvas")):AddUp("已成功儲存","儲存發生未知錯誤","Canvas"):AddUp("已成功發布","發布發生未知錯誤","Canvas")}else $removedFromShelves.is(":checked")?($removedFromShelves.prop("checked",!1),AddUp("已成功儲存，資料尚有缺漏或格式錯誤，未上架","儲存發生未知錯誤","Canvas")):AddUp("已成功儲存","儲存發生未知錯誤","Canvas")})):e.isDenied&&(window.location.hash=`${keyId}-1`)}))}))}function ElementInit(){$name=$("#InputName"),$name_count=$("#ProductForm .name .name_count"),$introduction=$("#InputIntroduction"),$introduction_count=$("#ProductForm .introduction .introduction_count"),$illustrate=$("#InputIllustrate"),$illustrate_count=$("#ProductForm .illustrate .illustrate_count"),$marks=$("#InputMarks"),$spec_select=$(".spec_select"),$price=$(".input_price"),$subItemNo=$(".input_subItemNo"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$date=$("#InputDate"),$permanent=$("#PermanentCheck"),$itemNo=$("#InputItemNo"),$itemNo_count=$("#ProductForm .itemNo .itemNo_count"),$display=$('#ProductForm [name="Visible"]'),$removedFromShelves=$('#ProductForm [name="RemovedFromShelves"]'),priceModal=new bootstrap.Modal(document.getElementById("PriceModal")),$price_modal=$("#PriceModal >.modal-dialog > .modal-content > .modal-body >.price_option"),$("#SortCheck").on("change",(function(){const e=$('[name="serNo"]');$(this).prop("checked")?e.removeAttr("disabled"):e.attr({disabled:"disabled"})})),document.getElementById("PriceModal").addEventListener("hidden.bs.modal",(function(e){$price_modal.children(".frame").each((function(){$(this).remove(),spec_price_num=0})),$(".input_price").each((function(){var e=$(this),t=e.parents(".spec_list").data("psid"),a=e.parents(".spec_list").data("temppsid"),n=e.parents(".price").find(".count"),i="",o=modal_price_list.filter((e=>!e.IsDelete&&(e.FK_PSId==t||e.TempPSid==a)));e.removeClass("multi-price"),o.length>1?(n.removeClass("d-none").text(o.length),e.addClass("multi-price")):n.addClass("d-none"),o.map((e=>{""!=i&&(i+="\n"),i+="現金："+co.String.thousandSign(e.Price),0!=e.Bonus&&(i+=" 紅利："+co.String.thousandSign(e.Bonus))})),o.length>0?e.val(i):e.val("")})),$(".alert_text").addClass("d-none")}))}function FormDataClear(){TechCertDataClear(),TagDataClear(),$("#Spec_Frame .spec_list").each((function(){$(this).remove()})),spec_num=0,keyId=0,$removedFromShelves.prop("checked",!1),$display.prop("checked",!1),$name.val(""),$name_count.text(0),$itemNo.val(""),$itemNo_count.text(0),$introduction.val(""),$introduction_count.text(0),$illustrate.val(""),$illustrate_count.text(0),$marks.val(""),$price.val(""),$subItemNo.val(""),$stock_number.val(""),$alert_number.val(""),$min_number.val(""),$permanent.prop("checked",!1),$date.val(""),$date.removeAttr("disabled"),startDate=null,endDate=null,spec_remove_list=[],modal_price_list=[],price_tid=0,temp_psid=0,$(".data_upload").each((function(){UploadPreviewFrameClear($(this))})),$(".data_upload > ul > .upload_list").remove(),total_files=[]}function contentReady(e){product_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(FormDataClear(),""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");0==parseInt(e)?e.includes("-1")?MoveToCanvas():co.Spec.GetPickSpecList().done((function(e){spec_pick_list=e,SpecAdd(null),MoveToContent()})):e.includes("-1")?(keyId=parseInt(e),MoveToCanvas()):co.Product.Get.ProdOne(parseInt(e)).done((function(e){null!=e?co.Spec.GetPickSpecList().done((function(t){spec_pick_list=t,FormDataSet(e),MoveToContent()})):BackToList(!1)}))}}else BackToList(!1)}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function paletteButtonClicked(e){$("#gjs").data("id",e.row.key),setPage(e.row.key),keyId=e.row.key+"-1",window.location.hash=keyId}function FormDataSet(e){TagDataSet(e.tagDatas),TechCertDataSet(e.techCertDatas),e.multimedia.forEach((e=>{UploadListAdd(e,$("#ProdMedia"))})),e.files.forEach((e=>{UploadListAdd(e,$("#ProdFiles"))})),$("#ProdMedia > ul > li:first-child").trigger("click"),e.stocks.forEach((function(e){e.prices.forEach((function(e){var t={};t.Id=e.id,t.Tempid=price_tid,t.FK_PSId=e.fK_PSId,t.TempPSid=0,t.FK_RId=e.fK_RId,t.Price=e.price,t.Bonus=e.bonus,t.SubItemNo=e.subItemNo,t.IsDelete=!1,price_tid+=1,modal_price_list.push(t)})),SpecAdd(e)})),startDate=e.startTime,endDate=e.endTime,keyId=e.id,disp_opt=e.disp_Opt,$removedFromShelves.prop("checked",!e.removedFromShelves),$display.prop("checked",e.visible),$name.val(e.title),$name_count.text($name.val().length),$itemNo.val(e.itemNo),$itemNo_count.text($itemNo.val().length),$introduction.val(e.introduction),$introduction_count.text($introduction.val().length),$illustrate.val(e.description),$illustrate_count.text($illustrate.val().length),$(`[name="ProdStatus"] > option[value="${e.status}"]`).prop("selected",!0),$date=$("#InputDate"),$(".linkToF").attr("href",`${defaultUrl}/${OrgName}/search/product/${e.id}`),$("#SortCheck").prop("checked",500!=e.ser_No),$('[name="serNo"]').val(e.ser_No),$("#SortCheck").trigger("change"),e.permanent?($date.val(""),$date.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate))}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Product.Delete.Prod(e.row.key).done((function(){product_list.component.refresh()})).fail((function(){Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)}))}))}function SpecPriceAdd(e){spec_price_num+=1;var t=$($("#ModalTemplatePrice").html()).clone(),a=t.find(".select_role"),n=t.find(".input_cash"),i=t.find(".input_bonus"),o=t.find(".btn_price_delete");t.data("ppid",null==e?0:e.Id),t.data("tempid",null==e?-1:e.Tempid),null!=e&&(a.val(e.FK_RId),n.val(e.Price),i.val(e.Bonus)),o.on("click",(function(){var e=$(this).parents(".modal_price").first();1==spec_price_num?co.sweet.error("商品至少需有一種價格",null,!1):co.sweet.confirm("移除價格","確定要移除此項價格嗎?","　是　","　否　",(function(){if(0==e.data("ppid")){if(e.data("tempid")>-1){var t=modal_price_list.findIndex((t=>t.Tempid==e.data("tempid")));modal_price_list[t].IsDelete=!0}}else{t=modal_price_list.findIndex((t=>t.Id==e.data("ppid")));modal_price_list[t].IsDelete=!0}spec_price_num-=1,e.remove()}))})),$("#PriceModal > .modal-dialog > .modal-content > .modal-body > .price_option").append(t),$("input[type='number']").on("input",(function(){var e=$(this),t=e.val();""!==t&&parseFloat(t)<0&&e.val("0")}))}function SpecPriceSave(){var e=[],t=!0;$price_modal.children(".frame").each((function(){$self=$(this);var a={};if(a.Id=$self.data("ppid"),a.Tempid=price_tid,a.FK_PSId=$self.parents(".modal-body").first().data("psid"),a.TempPSid=$self.parents(".modal-body").first().data("temppsid"),a.FK_RId=$self.find(".select_role").val(),a.Price=$self.find(".input_cash").val(),a.Bonus=$self.find(".input_bonus").val(),a.IsDelete=!1,0==a.Price&&0==a.Bonus)co.sweet.error("商品現金與紅利不可同時為空",null,!0),$(".alert_text").text("商品現金與紅利不可同時為空"),$(".alert_text").removeClass("d-none"),t=!1;else if(null!=e.find((e=>e.FK_RId==a.FK_RId&&(e.Price==a.Price||e.Bonus==a.Bonus))))co.sweet.error("商品現金或紅利不可重複",null,!0),$(".alert_text").removeClass("d-none"),$(".alert_text").text("同個會員等級下商品現金或紅利不可重複"),t=!1;else if(e.push(a),$(".alert_text").addClass("d-none"),$self.data("tempid")<0)modal_price_list.push(a),price_tid+=1;else{var n=modal_price_list.findIndex((e=>e.Tempid==$self.data("tempid")));modal_price_list[n].FK_RId=$self.find(".select_role").val(),modal_price_list[n].Price=$self.find(".input_cash").val(),modal_price_list[n].Bonus=$self.find(".input_bonus").val()}})),t&&priceModal.hide()}function SpecAdd(e){spec_num+=1,$("#Spec_Frame").data("spec_num",spec_num);var t=$($("#TemplateSpecification").html()).clone(),a=t.find(".input_spec").first(),n=t.find(".input_spec").last(),i=t.find("datalist").first(),o=t.find("datalist").last(),s=t.find(".input_price"),d=t.find(".price > .count"),l=t.find(".input_subItemNo"),r=t.find(".input_min_number"),c=t.find(".input_stock_number"),p=t.find(".input_alert_number"),u=t.find(".collapse"),m=t.find(".btn_expand"),f=t.find(".btn_remove");null!=e?(t.find(".ser_no").val(e.ser_No),t.data("serno",e.ser_No)):(t.find(".ser_no").val(spec_num),t.data("serno",spec_num)),t.find(".ser_no").on("blur",(function(){var e=$(this);e.val()<1?e.val(1):e.val()>$(".spec_list").length&&e.val($(".spec_list").length),e.val()!=t.data("serno")&&(e.val()>t.data("serno")?(SortChange($(".spec_list"),"bigger",t.data("serno"),e.val()),$("#Spec_Frame > ul.specList").children("li").eq(parseInt(e.val())-1).after(t)):e.val()<t.data("serno")&&(SortChange($(".spec_list"),"smaller",e.val(),t.data("serno")),$("#Spec_Frame > ul.specList").children("li").eq(parseInt(e.val())-1).before(t))),t.data("serno",e.val())})),t.find(".spec").each((function(){var e=$($("#TemplateSpecType").html()).clone();$(this).prepend(e)}));var _=t.find(".spec_select").first(),v=t.find(".spec_select").last();if(null!=e&&null!=e.fK_ST1id&&(_.val(e.fK_ST1id),e.fK_ST1id>0)){_.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var e=$(this);e.val()==_.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),a.removeAttr("disabled");var h=spec_pick_list.find((e=>e.id==_.val()));h.specs.length>0&&h.specs.forEach((t=>{i.append(`<option value="${t.title}" data-sid="${t.id}"></option>`),t.id==e.fK_S1id&&(a.val(t.title),a.data("id",t.id))}))}if(null!=e&&null!=e.fK_ST2id&&(v.val(e.fK_ST2id),e.fK_ST2id>0)){v.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var e=$(this);e.val()==v.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),n.removeAttr("disabled");h=spec_pick_list.find((e=>e.id==v.val()));h.specs.length>0&&h.specs.forEach((t=>{o.append(`<option value="${t.title}" data-sid="${t.id}"></option>`),t.id==e.fK_S2id&&(n.val(t.title),n.data("id",t.id))}))}null!=e?(t.data("psid",e.id),t.data("oldstock",e.stock)):(temp_psid+=1,t.data("temppsid",temp_psid),t.data("oldstock",null));var g="",I=modal_price_list.filter((e=>!e.IsDelete&&e.FK_PSId==t.data("psid")));s.removeClass("multi-price"),I.length>1?(s.addClass("multi-price"),d.removeClass("d-none").text(I.length)):d.addClass("d-none"),I.map((e=>{""!=g&&(g+="\n"),g+="現金："+co.String.thousandSign(e.Price),0!=e.Bonus&&(g+=" 紅利："+co.String.thousandSign(e.Bonus))})),I.length>0?s.val(g):s.val(""),l.val(null!=e?e.subItemNo:""),r.val(null!=e?e.min_Qty:""),c.val(null!=e?e.stock+e.orderStock:""),p.val(""),p.val(null!=e?e.alert_Qty:""),u.attr("id","CollapseDetail"+spec_num),m.attr("data-bs-target","#CollapseDetail"+spec_num),m.attr("aria-controls","CollapseDetail"+spec_num),a.attr("list","SpecListOpt"+spec_num+"-1"),n.attr("list","SpecListOpt"+spec_num+"-2"),i.attr("id","SpecListOpt"+spec_num+"-1"),o.attr("id","SpecListOpt"+spec_num+"-2"),s.on("click",(function(){var e=!0,t=$(this),a=t.parents(".spec_list").data("psid"),n=t.parents(".spec_list").data("temppsid");$price_modal.parents(".modal-body").first().data("psid",null!=a?a:""),$price_modal.parents(".modal-body").first().data("temppsid",null!=n?n:""),modal_price_list.forEach((function(t){(t.FK_PSId==a||null!=t.TempPSid&&t.TempPSid==n)&&(SpecPriceAdd(t),e=!1)})),e&&SpecPriceAdd(null),priceModal.show()})),null!=e&&(m.children("span").text("expand_more"),m.parents("div").first().prev().removeClass("show")),m.on("click",(function(){var e=$(this);"expand_less"==e.children("span").text()?e.children("span").text("expand_more"):e.children("span").text("expand_less")})),f.on("click",(function(e){e.preventDefault();var a=$(this).parents(".spec_list");1==spec_num?co.sweet.error("商品至少需有一種規格",null,!1):co.sweet.confirm("移除規格","確定要移除此項規格嗎?","　是　","　否　",(function(){spec_remove_list.push(a.data("psid")),spec_num-=1,t.data("serno")<$("#Spec_Frame").data("spec_num")&&SortChange($(".spec_list"),"bigger",t.data("serno"),$("#Spec_Frame").data("spec_num")),a.remove(),$("#Spec_Frame").data("spec_num",spec_num)}))})),t.find(".spec_select").each((function(){$self=$(this);var e=$self.siblings(".input_spec");$self.on("change",(function(){var t=$(this),a=t.parents(".spec").first().siblings(".spec"),n=t.siblings("datalist");if(e.val(""),n.children("option").each((function(){$(this).remove()})),a.children(".spec_select").children("option").each((function(){var e=$(this);e.removeAttr("disabled"),e.removeClass("bg-secondary-light25")})),0==t.val())e.attr("disabled","disabled");else{a.children(".spec_select").children("option").each((function(){var e=$(this);e.val()==t.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),e.removeAttr("disabled");var i=spec_pick_list.find((e=>e.id==t.val()));i.specs.length>0&&i.specs.forEach((e=>{n.append(`<option value="${e.title}" data-sid="${e.id}"></option>`)}))}})),$self.siblings(".input_spec").blur((function(){SpecBlurFunction($(this))}))})),$("#Spec_Frame ul .btn_spec_add").before(t),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$("input[type='number']").on("input",(function(){var e=$(this),t=e.val();""!==t&&parseFloat(t)<0&&e.val("0")}))}function SpecBlurFunction(e){var t,a;""!=e.val()&&(a=0,e.each((function(){$self_input=$(this),$self_input.siblings("datalist").children("option").each((function(){(t=$(this)).val()==$self_input.val()&&(a=t.data("sid"))}))})),0==a&&co.Spec.SpecAddUp({FK_Tid:e.prev("select").val(),Title:e.val()}).done((function(t){t.success&&co.Spec.GetPickSpecList().done((function(a){spec_pick_list=a,$self_input.siblings("datalist").append(`<option value="${e.val()}" data-sid="${t.message}"></option>`)}))})))}function ISpecRepect(){var e=[],t=[],a=!1;return $("#Spec_Frame .spec_list").each((function(){$self=$(this),$self.find(".input_spec").each((function(){e.push($(this).val())})),null!=t.find((t=>t[0]==e[0]&&t[1]==e[1]))?a=!0:(t.push(e),e=[])})),a}function UploadListAdd(e,t){var a=$($("#TemplateUploadList").html()).clone(),n=a.find(".ser_no"),i=a.find(".btn_remove"),o=t.find("ul > li").length-1,s=total_files.length;if(void 0===o&&(o=0),null==e)t.find("ul > li").each((function(){var e=$(this);e.hasClass("upload_list")&&""==e.find(".title").text()&&(e.remove(),o-=1)})),o+=1,a.data("tempid",s),a.data("serno",o),n.val(o),0==t.find(".select_frame").length&&void 0!==t.data("uploadtype")?a.data("uploadtype",t.data("uploadtype")):a.data("uploadtype",0),a.data("edit",!1),a.on("click",(function(){co.File.ListFile($(this))}));else if(void 0===e.id)a.data("tempid",e.TempId),a.data("serno",o),n.val(o),a.data("uploadtype",e.Type),a.data("edit",!1),a.find(".title").text(e.Name),e.Link?a.find(".thumb_img").attr("src",e.Link):2==e.Type?a.find(".thumb_img").attr("src","/images/defaultImage/360.jpg"):3==e.Type&&a.find(".thumb_img").attr("src","/images/defaultImage/video.jpg"),a.on("click",(function(){co.File.ListFile($(this))}));else{o+=1,a.data("id",e.id),a.data("serno",o),n.val(o),a.data("uploadtype",e.fileType),a.data("edit",!1),a.find(".title").text(e.name);var d={};d.Id=e.id,d.Name=e.name;var l=e.link[0];if(4==e.fileType?d.File=e.name:d.File=l,d.Type=e.fileType,d.IsDelete=!1,d.File){switch(d.Type){case 2:a.find(".thumb_img").attr("src","/images/defaultImage/360.jpg");break;case 3:a.find(".thumb_img").attr("src","/images/defaultImage/video.jpg");break;case 4:a.find(".thumb_img").attr("src",`https://img.youtube.com/vi/${d.File}/hqdefault.jpg`);break;default:a.find(".thumb_img").attr("src",d.File)}a.find(".btn_link").removeClass("d-none").attr("href",d.File)}else a.find(".btn_link").addClass("d-none");total_files.push(d),a.on("click",(function(){co.File.ListFile($(this))}))}t.data("file_num",o),n.on("blur",(function(){var e=$(this),n=t.find(".upload_list");e.val()<1?e.val(1):e.val()>n.length&&e.val(n.length),e.val()!=a.data("serno")&&(e.val()>a.data("serno")?(SortChange(n,"bigger",a.data("serno"),e.val()),$("#ProductForm > .data_upload > ul").children("li").eq(parseInt(e.val())-1).after(a)):e.val()<a.data("serno")&&(SortChange(n,"smaller",e.val(),a.data("serno")),$("#ProductForm > .data_upload > ul").children("li").eq(parseInt(e.val())-1).before(a))),a.data("serno",e.val())})),i.on("click",(function(e){e.preventDefault();var n=$(this).parents("li").first(),i=t.find(".upload_list");if(a.data("serno")<t.data("file_num")&&SortChange(i,"bigger",a.data("serno"),t.data("file_num")),void 0!==n.data("id"))total_files.find((e=>e.Id==n.data("id"))).IsDelete=!0;else if(void 0!==n.data("tempid")){var o=n.data("tempid"),s=total_files.findIndex((e=>e.TempId==o));s>=0&&(total_files.splice(s,1),total_files.forEach((e=>{e.TempId=e.TempId>o?e.TempId-1:e.TempId})))}UploadPreviewFrameClear(t),n.remove(),t.data("file_num",t.data("file_num")-1)})),t.find("ul > .btn_upload_add").before(a),co.File.ListFile(a)}function UploadPreviewFrameClear(e){var t=e.find(".preview_frame");t.find(".default_frame").addClass("d-flex"),t.find(".upload_frame").addClass("d-none"),t.find(".media_frame").removeClass("d-flex"),t.find(".youtube_frame").removeClass("d-flex"),t.find(".select_frame").removeClass("d-flex"),t.find(".youtube_preview").empty(),t.find(".media_preview > div").empty()}function SortChange(e,t,a,n){e.each((function(){var e=$(this);"bigger"==t?e.data("serno")>a&&e.data("serno")<=n&&(e.find(".ser_no").val(parseInt(e.data("serno"))-1),e.data("serno",e.find(".ser_no").val())):"smaller"==t&&e.data("serno")>=a&&e.data("serno")<n&&(e.find(".ser_no").val(parseInt(e.data("serno"))+1),e.data("serno",e.find(".ser_no").val()))}))}function AddUp(e,t,a){var n=[];$("#Spec_Frame ul li.spec_list").each((function(){var e=$(this),t={},a=[];e.find(".input_spec").each((function(){var e=0;$self_input=$(this),$self_input.siblings("datalist").children("option").each((function(){var t=$(this);t.val()==$self_input.val()&&(e=t.data("sid"))})),a.push(e)})),t.Id=""==e.data("psid")?0:e.data("psid"),t.FK_S1id=a[0],t.FK_S2id=a[1],t.Stock=e.find(".input_stock_number").val(),t.Alert_Qty=e.find(".input_alert_number").val(),t.Min_Qty=e.find(".input_min_number").val(),t.Ser_No=e.find(".ser_no").val(),t.OldStock=e.data("oldstock"),t.SubItemNo=e.find(".input_subItemNo").val();var i=[];modal_price_list.forEach((function(t){if(t.FK_PSId==e.data("psid")||t.TempPSid==e.data("temppsid")){var a={};a.Id=t.Id,a.FK_PSId=t.FK_PSId,a.FK_RId=t.FK_RId,a.Price=t.Price,a.Bonus=t.Bonus,a.IsDelete=t.IsDelete,i.push(a)}})),t.Prices=i,n.push(t)})),co.Product.AddUp.Product({Id:keyId,Title:$name.val(),ItemNo:$itemNo.val(),Visible:$display.is(":checked"),RemovedFromShelves:!$removedFromShelves.is(":checked"),Ser_No:$("#SortCheck").is(":checked")?$('[name="serNo"]').val():500,Introduction:$introduction.val(),Description:$illustrate.val(),StartTime:startDate,EndTime:endDate,Permanent:$permanent.is(":checked"),TagSelected:tag_list,TechCertSelected:techcert_list,Stocks:n,Status:$('[name="ProdStatus"] > option:selected').val()}).done((function(n){var i=parseInt(n.message);if(n.success){Coker.sweet.success(e,null,!0);var o=[];if(total_files.length>0)switch($("#ProductForm .data_upload > ul > li").each((function(){var e=$(this);if(!e.hasClass("btn_upload_add")){var t=[];if(total_files.forEach((a=>{(void 0!==a.Id&&a.Id==e.data("id")||void 0!==a.TempId&&a.TempId==e.data("tempid"))&&t.push(a)})),t.length>0)switch(t[0].Type){case 1:if("string"==typeof t[0].File)co.File.fileSortChange({Id:t[0].Id,Sid:i,SerNo:e.find(".ser_no").val()});else(d=new FormData).append("type",1),d.append("sid",i),d.append("serno",e.find(".ser_no").val()),t.forEach((e=>{for(var a=0;a<e.File.length;a++)d.append("files",e.File[a]);o.push(co.File.Upload(d).done((function(e){var a=$.Deferred();if(e.success){for(let a=0;a<t.length;a++)t[a].Id=e.files[a].id,t[a].File=e.files[a].path;return a.resolve()}return a.reject()}))),d.delete("files")}));break;case 2:(d=new FormData).append("type",1),d.append("sid",i),d.append("serno",e.find(".ser_no").val());for(var a=0;a<t.length;a+=3){for(var n=a;n<a+3;n++)d.append("files",t[n]);d.delete("files")}break;case 3:if("string"==typeof t[0].File)co.File.fileSortChange({Id:t[0].Id,sid:i,SerNo:e.find(".ser_no").val()});else(d=new FormData).append("files",t[0].File),d.append("type",1),d.append("sid",i),d.append("serno",e.find(".ser_no").val()),o.push(co.File.Upload(d).done((function(e){e.success&&(t[0].Id=e.files[0].id,t[0].File=e.files[0].path)})));break;case 4:var s=void 0===t[0].Id?0:t[0].Id;o.push(co.File.UploadYTLink({Id:s,File:t[0].File+"",SId:i,Type:1,SerNo:e.find(".ser_no").val()}).done((function(e){var a=$.Deferred();return e.success&&void 0!==e.files?(t[0].Id=e.files[0].id,a.resolve()):a.reject()})));break;case 5:var d;if("string"==typeof t[0].File)co.File.fileSortChange({Id:t[0].Id,sid:i,SerNo:e.find(".ser_no").val()});else(d=new FormData).append("files",t[0].File),d.append("type",8),d.append("sid",i),d.append("serno",e.find(".ser_no").val()),o.push(co.File.Upload(d).done((function(e){var a=$.Deferred();return e.success?(t[0].Id=e.files[0].id,t[0].File=e.files[0].path,a.resolve()):a.reject()})))}}})),total_files.forEach((e=>{if(void 0!==e.IsDelete&&1==e.IsDelete)switch(e.Type){case 2:break;case 1:case 3:case 4:case 5:if(void 0!==e.Id){var t=[];t.push(e.Id),o.push(co.File.DeleteFileById({Sid:parseInt(n.message),Type:5==e.Type?8:1,Fid:t}))}}})),a){case"List":setTimeout((function(){BackToList(!0)}),1e3);break;case"Canvas":setTimeout((function(){window.location.hash=`${i}-1`}),1e3)}else switch(a){case"List":setTimeout((function(){BackToList(!0)}),1e3);break;case"Canvas":setTimeout((function(){window.location.hash=`${i}-1`}),1e3)}$.when.apply(null,o).done((function(){HashDataEdit()}))}else Coker.sweet.error("錯誤",t,null,!0)})).fail((function(){Coker.sweet.error("錯誤",t,null,!0)})),spec_remove_list.length>0&&spec_remove_list.forEach((function(e){co.Product.Delete.Stock(e)}))}function setTotalFile(e){total_files.forEach(((t,a)=>{e.data.forEach(((e,t)=>{a.TempId}))}))}function MoveToContent(){0==keyId?$("#ProductContent .card-header .titile").text("新增商品"):$("#ProductContent .card-header .titile").text("編輯商品"),$("#ProductForm").removeClass("was-validated"),$("#ProductList").addClass("d-none"),$("#ProductCanvas").addClass("d-none"),$("#ProductContent").removeClass("d-none"),tagContentRefresh()}function MoveToCanvas(){$("#gjs").data("id",keyId),setPage(keyId),$("#TopLine > a").removeClass("d-none"),$("#ProductList").addClass("d-none"),$("#ProductContent").addClass("d-none"),$("#ProductCanvas").removeClass("d-none")}function BackToList(e){$("#TopLine > a").addClass("d-none"),$("#ProductList").removeClass("d-none"),$("#ProductCanvas").addClass("d-none"),$("#ProductContent").addClass("d-none"),e&&(window.location.hash="",product_list.component.refresh())}