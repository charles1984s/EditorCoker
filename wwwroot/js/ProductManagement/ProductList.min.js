var $btn_display,$name,$name_count,$introduction,$introduction_count,$illustrate,$illustrate_count,$marks,$tag,$price,$stock_number,$alert_number,$min_number,$date,$picker,$permanent,startDate,endDate,keyId,product_list,$price_modal,priceModal,disp_opt=!0,spec_num=0,spec_price_num=0,spec_remove_list=[],spec_price_remove_list=[],modal_price_list=[];function PageReady(){co.Product={AddUp:{Product:function(e){return $.ajax({url:"/api/Product/ProductAddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(e),dataType:"json"})},Stock:function(e){return $.ajax({url:"/api/Product/StockAddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(e),dataType:"json"})}},Get:{ProdOne:function(e){return $.ajax({url:"/api/Product/GetProdDataOne/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{id:e}})},ProdStock:function(e){return $.ajax({url:"/api/Product/GetStockDataAll/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{PId:e}})},SpecType:function(){return $.ajax({url:"/api/Product/GetSpecType/",type:"GET",headers:_c.Data.Header})},Spec:function(e){return $.ajax({url:"/api/Product/GetSpecDetail/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{typeid:e}})}},Delect:{Prod:function(e){return $.ajax({url:"/api/Product/ProdDelete",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(e),dataType:"json"})},Stock:function(e){return $.ajax({url:"/api/Product/StockDelete",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(e),dataType:"json"})}}},ElementInit(),$picker=$("#InputDate"),co.Picker.Init($picker),$picker.on("apply.daterangepicker",(function(e,t){$(this).val(t.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+t.endDate.format("YYYY/MM/DD HH:mm")),startDate=t.startDate.format(""),endDate=t.endDate.format("")}));const e=$("#ProductForm");Array.from(e).forEach((e=>{e.addEventListener("submit",(t=>{e.checkValidity()?(t.preventDefault(),ISpecRepect()?co.sweet.error("錯誤","商品規格不可重複",null,!1):Coker.sweet.confirm("即將發布","發布後將直接顯示於安排的位置","發布","取消",(function(){AddUp(disp_opt,"已成功發布","發布發生未知錯誤")}))):(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回商品列表","資料將不被保存","確定","取消",(function(){history.back()}))})),$(".btn_add").on("click",(function(){window.location.hash=0,HashDataEdit()})),$(".btn_save").on("click",(function(){disp_opt=!1,$btn_display.children("span").text("visibility_off"),AddUp(!1,"已存為草稿","儲存草稿發生未知錯誤")})),$(".btn_input_pic").on("click",(function(e){e.preventDefault(),$(".input_pic").click()})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$(".btn_expand_out").on("click",(function(){var e=$(this);"expand_more"==e.children("span").text()?e.children("span").text("expand_less"):e.children("span").text("expand_more")})),$(".btn_spec_add").on("click",SpecAdd),$(".btn_spec_price_add").on("click",SpecPriceAdd),$(".btn_price_save").on("click",SpecPriceSave),$name.on("keyup",(function(){$name_count.text($name.val().length)})),$introduction.on("keyup",(function(){$introduction_count.text($introduction.val().length)})),$illustrate.on("keyup",(function(){$illustrate_count.text($illustrate.val().length)})),$permanent.on("click",(function(){$permanent.is(":checked")?($date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null):$date.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function ElementInit(){$btn_display=$("#Btn_Display"),$name=$("#InputName"),$name_count=$("#ProductForm > .name .name_count"),$introduction=$("#InputIntroduction"),$introduction_count=$("#ProductForm > .introduction .introduction_count"),$illustrate=$("#InputIllustrate"),$illustrate_count=$("#ProductForm > .illustrate .illustrate_count"),$marks=$("#InputMarks"),$tag=$("#InputTag"),$spec_select=$(".spec_select"),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$date=$("#InputDate"),$permanent=$("#PermanentCheck"),priceModal=new bootstrap.Modal(document.getElementById("PriceModal")),$price_modal=$("#PriceModal >.modal-dialog > .modal-content > .modal-body >.price_option"),document.getElementById("PriceModal").addEventListener("hidden.bs.modal",(function(e){$price_modal.children(".frame").each((function(){$(this).remove(),modal_price_list=[],spec_price_num=0}))}))}function FormDataClear(){$("#Spec_Frame > .frame").each((function(){$(this).remove()})),spec_num=0,keyId=0,$btn_display.children("span").text("visibility"),disp_opt=!0,$name.val(""),$name_count.text(0),$introduction.val(""),$introduction_count.text(0),$illustrate.val(""),$illustrate_count.text(0),$marks.val(""),$tag.val(""),$price.val(""),$stock_number.val(""),$alert_number.val(""),$min_number.val(""),$permanent.prop("checked",!1),$date.val(""),$date.removeAttr("disabled"),startDate=null,endDate=null,spec_remove_list=[]}function contentReady(e){product_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");0==parseInt(e)?(FormDataClear(),SpecAdd(null),MoveToContent()):co.Product.Get.ProdOne(parseInt(e)).done((function(e){null!=e?(FormDataSet(e),MoveToContent()):window.location.hash=""}))}}else BackToList()}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function FormDataSet(e){FormDataClear(),co.Product.Get.ProdStock(e.id).done((function(e){e.forEach((function(e){SpecAdd(e)}))})),startDate=e.startTime,endDate=e.endTime,keyId=e.id,disp_opt=e.disp_Opt,$btn_display.children("span").text(e.disp_Opt?"visibility":"visibility_off"),$name.val(e.title),$name_count.text($name.val().length),$introduction.val(e.introduction),$introduction_count.text($introduction.val().length),$illustrate.val(e.description),$illustrate_count.text($illustrate.val().length),$marks.val(""),$tag.val(""),$date=$("#InputDate"),e.permanent?($date.val(""),$date.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate))}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Product.Delect.Prod({Id:e.row.key,TId:$.cookie("secret")}).done((function(){product_list.component.refresh()})).fail((function(){Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)}))}))}function SpecPriceAdd(e){spec_price_num+=1;var t=$($("#ModalTemplatePrice").html()).clone();t.find(".select_role"),t.find(".input_cash"),t.find(".input_bonus");t.find(".btn_price_delect").on("click",(function(){$self_p=$(this).parents(".frame").first(),1==spec_price_num?co.sweet.error("商品至少需有一種價格",null,!1):co.sweet.confirm("移除價格","確定要移除此項價格嗎?","　是　","　否　",(function(){spec_price_remove_list.push($self_p.data("ppid")),spec_price_num-=1,$self_p.remove()}))})),$("#PriceModal > .modal-dialog > .modal-content > .modal-body > .price_option").append(t),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function SpecPriceSave(){var e=!0,t=[];modal_price_list=[],$price_modal.children(".frame").each((function(){return $self=$(this),t.PSid=$self.find(".select_role").val(),t.Rid=$self.find(".select_role").val(),t.Price=$self.find(".input_cash").val(),t.Bonus=$self.find(".input_bonus").val(),""==t.Price&&""==t.Bonus?(co.sweet.error("錯誤","商品現金與紅利不可同時為空",null,!1),e=!1,!1):null!=modal_price_list.find((e=>e[0]==t[0]&&e[1]==t[1]&&e[2]==t[2]))?(co.sweet.error("錯誤","價格不可重複",null,!1),e=!1,!1):(modal_price_list.push(t),void(t=[]))})),e&&(priceModal.hide(),console.log(modal_price_list),console.log($price_modal.data("psid")))}function SpecAdd(e){spec_num+=1;var t=$($("#TemplateSpecification").html()).clone(),n=t.find(".select"),a=t.find(".input_price"),i=t.find(".input_min_number"),o=t.find(".input_stock_number"),c=t.find(".input_alert_number"),r=t.find(".collapse"),l=t.find(".btn_expand"),d=t.find(".btn_delect");co.Product.Get.SpecType().done((function(t){null!=t&&t.forEach((function(t){var a=$($("#TemplateSpecSelect").html()).clone(),i=a.find("select");co.Product.Get.Spec(t.id).done((function(n){i.attr("aria-label",t.title),null!=e?(i.append('<option value="" disabled="disabled">'+t.title+"</option>"),i.append('<option value="0">無</option>'),n.forEach((function(t){t.id==e.fK_S1id||t.id==e.fK_S2id?i.append('<option selected value="'+t.id+'">'+t.title+"</option>"):i.append('<option value="'+t.id+'">'+t.title+"</option>")}))):(i.append('<option selected value="" disabled="disabled">'+t.title+"</option>"),i.append('<option value="0">無</option>'),n.forEach((function(e){i.append('<option value="'+e.id+'">'+e.title+"</option>")})))})),n.append(a)}))})),t.data("psid",null!=e?e.id:""),a.val(null!=e?e.price:""),i.val(null!=e?e.min_Qty:""),o.val(null!=e?e.stock:""),c.val(""),c.val(null!=e?e.alert_Qty:""),r.attr("id","CollapseDetail"+spec_num),l.attr("data-bs-target","#CollapseDetail"+spec_num),l.attr("aria-controls","CollapseDetail"+spec_num),l.on("click",(function(){var e=$(this);"expand_more"==e.children("span").text()?e.children("span").text("expand_less"):e.children("span").text("expand_more")})),d.on("click",(function(){$self_p=$(this).parents(".frame").first(),1==spec_num?co.sweet.error("商品至少需有一種規格",null,!1):co.sweet.confirm("移除規格","確定要移除此項規格嗎?","　是　","　否　",(function(){spec_remove_list.push($self_p.data("psid")),spec_num-=1,$self_p.remove()}))})),$("#Spec_Frame").append(t),$spec_select=$(".spec_select"),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function ISpecRepect(){var e=[],t=[],n=!1;return $("#Spec_Frame > .frame").each((function(){$self=$(this),$self.find(".spec_select").each((function(){e.push($(this).val())})),null!=t.find((t=>t[0]==e[0]&&t[1]==e[1]))?n=!0:(t.push(e),e=[])})),n}function AddUp(e,t,n){spec_remove_list.length>0&&spec_remove_list.forEach((function(e){co.Product.Delect.Stock({Id:e,TId:$.cookie("secret")})})),co.Product.AddUp.Product({TId:$.cookie("secret"),Id:keyId,Title:$name.val(),Disp_Opt:e,Ser_No:500,Introduction:$introduction.val(),Description:$illustrate.val(),StartTime:startDate,EndTime:endDate,Permanent:$permanent.is(":checked")}).done((function(e){keyId=null==e.message?keyId:e.message,$("#Spec_Frame > .frame").each((function(){$self=$(this);var e=[];$self.find(".spec_select").each((function(){e.push($(this).val())})),co.Product.AddUp.Stock({TId:$.cookie("secret"),Id:""==$self.data("psid")?0:$self.data("psid"),Pid:keyId,FK_S1id:e[0],FK_S2id:e[1],Price:$self.find(".input_price").val(),Stock:$self.find(".input_stock_number").val(),Min_Qty:$self.find(".input_min_number").val(),Alert_Qty:$self.find(".input_alert_number").val()}).done((function(){Coker.sweet.success(t,null,!0),setTimeout((function(){BackToList(),product_list.component.refresh()}),1e3)})).fail((function(){Coker.sweet.error("錯誤",n,null,!0)}))}))})).fail((function(){Coker.sweet.error("錯誤",n,null,!0)}))}function MoveToContent(){$("#ProductForm").removeClass("was-validated"),$("#ProductList").addClass("d-none"),$("#ProductContent").removeClass("d-none")}function BackToList(){$("#ProductList").removeClass("d-none"),$("#ProductContent").addClass("d-none"),window.location.hash=""}