var $btn_display,$name,$name_count,$introduction,$introduction_count,$illustrate,$illustrate_count,$marks,$price,$stock_number,$alert_number,$min_number,$date,$picker,$permanent,startDate,endDate,keyId,price_tid,temp_psid,product_list,spec_pick_list,$price_modal,priceModal,disp_opt=!0,spec_num=0,spec_price_num=0,spec_remove_list=[],modal_price_list=[],file_num=0,total_files=[];let importProdPopup=null;function ImportProd(){var e=new FormData($('[name="fileUploadForm"]')[0]);co.Product.AddUp.Import(e).done((function(e){importProdPopup.hide(),co.sweet.success("檔案上傳成功"),null!=product_list&&product_list.component.refresh()})).fail((function(){co.sweet.error("檔案格式錯誤，無法解讀。")}))}function showImportProdPopup(){importProdPopup=$("#importProdPopup").dxPopup("instance"),importProdPopup.option("contentTemplate",$("#importProdPopup-template")),importProdPopup.option("title","商品匯入"),importProdPopup.show()}function toolbarPreparing(e){e.component;e.toolbarOptions.items.unshift({location:"after",widget:"dxButton",options:{icon:"fa-solid fa-file-excel",text:"商品匯入",onClick:showImportProdPopup}})}function PageReady(){ElementInit(),TechCertListModalInit(),TagListModalInit(),$(".btn_upload_add > button").on("click",(function(e){e.preventDefault(),UploadListAdd(null)})),$(window).on("fileUploadWithPreview:imagesAdded",(function(e){var t=upload_file.cachedFileArray;$("#ProductForm > .data_upload > ul > li").each((function(){var e=$(this);if(e.data("edit"))switch(e.data("uploadtype")){case 1:var a=[];t.forEach((function(e,i){n=e.name.substring(0,e.name.indexOf(":")),d=e.type,a.push(new File(t.slice(i,i+1),n,{type:d}))}));var i=[];file_num--,a.forEach((function(t,a){var i=[];i.push(t);var n={};n.TempId=e.data("tempid")+a,n.Type=e.data("uploadtype");var d=new FileReader;d.readAsDataURL(i[0]),d.onload=function(e){n.Link=e.target.result},htmlImageCompress=new HtmlImageCompress(i[0],{quality:.7,width:500,height:500,imageType:i[0].type}),htmlImageCompress.then((function(e){i.push(new File([e.file],e.origin.name,{type:e.file.type})),htmlImageCompress=new HtmlImageCompress(i[0],{quality:.3,width:150,height:150,imageType:i[0].type}),htmlImageCompress.then((function(e){i.push(new File([e.file],e.origin.name,{type:e.file.type})),n.File=i,n.IsDelete=!1,n.Name=e.origin.name,total_files.push(n),UploadListAdd(n)})).catch((function(e){UploadPreviewFrameClear(),console.log($`發生錯誤：${e}`),co.sweet.error("資料上傳失敗","請重新上傳",null,null)}))})).catch((function(e){UploadPreviewFrameClear(),console.log($`發生錯誤：${e}`),co.sweet.error("資料上傳失敗","請重新上傳",null,null)}))}));break;case 2:a=[];t.forEach((function(e,i){n=e.name.substring(0,e.name.indexOf(":")),d=e.type,a.push(new File(t.slice(i,i+1),n,{type:d}))})),a.forEach((function(t,a){var i=[];i.push(t),htmlImageCompress=new HtmlImageCompress(i[0],{quality:.7}),htmlImageCompress.then((function(t){i.push(new File([t.file],t.origin.name,{type:t.file.type})),htmlImageCompress=new HtmlImageCompress(i[0],{quality:.3}),htmlImageCompress.then((function(t){var a={};i.push(new File([t.file],t.origin.name,{type:t.file.type})),a.File=i,a.TempId=e.data("tempid"),a.Name=t.origin.name,a.Type=e.data("uploadtype"),a.IsDelete=!1,total_files.push(a)})).catch((function(e){console.log($`發生錯誤：${e}`),UploadPreviewFrameClear(),co.sweet.error("資料上傳失敗","請重新上傳",null,null)}))})).catch((function(e){console.log($`發生錯誤：${e}`),UploadPreviewFrameClear(),co.sweet.error("資料上傳失敗","請重新上傳",null,null)}))})),e.find(".title").text(`${a[0].name}...共${a.length}張圖`);break;case 3:var n,d;a=[];t.forEach((function(e,i){n=e.name.substring(0,e.name.indexOf(":")),d=e.type,a.push(new File(t.slice(i,i+1),n,{type:d}))}));i=[];a.forEach((function(t,a){var n={};n.File=t,n.TempId=e.data("tempid")+a,n.Type=e.data("uploadtype"),n.IsDelete=!1,n.Name=t.name,total_files.push(n),i.push(n)})),file_num--,i.forEach((function(e){UploadListAdd(e)}))}}))})),$(window).on("fileUploadWithPreview:imageDeleted",(function(e){$("#ProductForm > .data_upload > ul > li").each((function(){var e=$(this);if(e.data("edit")){var t=upload_file.cachedFileArray;if(t.length<1)e.data("file",""),e.find(".title").text("");else{var a=[];t.forEach((function(e,i){var n=e.name.substring(0,e.name.indexOf(":")),d=e.type;a.push(new File(t.slice(i,i+1),n,{type:d}))})),e.data("file",a)}}}))})),$(window).on("fileUploadWithPreview:clearButtonClicked",(function(e){$("#ProductForm > .data_upload > ul > li").each((function(){var e=$(this);if(e.data("edit")){if(e.data("serno")<file_num&&SortChange("bigger",e.data("serno"),file_num),void 0!==e.data("id"))total_files.find((t=>t.Id==e.data("id"))).IsDelete=!0;else if(void 0!==e.data("tempid")){var t=e.data("tempid"),a=total_files.findIndex((e=>e.TempId==t));total_files.splice(a,1),total_files.forEach((e=>{e.TempId=e.TempId>t?e.TempId-1:e.TempId}))}UploadPreviewFrameClear(),e.remove(),file_num-=1}}))})),$("#BtnConnect").on("click",(function(e){var t;e.preventDefault(),$("#ProductForm > .data_upload > ul > .upload_list").each((function(){var e=$(this);e.data("edit")&&(t=e)}));var a=$(this).prev().val(),i=a.indexOf("watch?v=")+8;if($(".youtube_preview").children("*").remove(),""!=a&&i>-1&&""!=a.substring(i)){var n=`<iframe class="yt_preview w-100 h-100" src="${"https://www.youtube.com/embed/"+a.substring(i)}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;if($(".youtube_preview").append(n),t.find(".title").text(a),void 0!==total_files.find((e=>e.Id==t.data("id"))))total_files.find((e=>e.Id==t.data("id"))).File!=a.substring(i)&&(total_files.find((e=>e.Id==t.data("id"))).File=a.substring(i));else if(void 0!==total_files.find((e=>e.TempId==t.data("tempid"))))total_files.find((e=>e.TempId==t.data("tempid"))).File!=a.substring(i)&&(total_files.find((e=>e.TempId==t.data("tempid"))).File=a.substring(i));else{var d={};d.File=a.substring(i),d.TempId=t.data("tempid"),d.Type=t.data("uploadtype"),d.IsDelete=!1,total_files.push(d)}}else{$(".youtube_preview").append("<div class='w-100 h-100 d-flex justify-content-center align-items-center bg-black bg-opacity-25 fw-bold'>請輸入正確的Youtube連結</div>"),t.find(".title").text(""),t.data("file","")}})),$((function(){var e,t,a;$("#ProductForm > .data_upload > ul").sortable({items:"> .upload_list",axis:"y",cursor:"move",dropOnEmpty:!1,start:function(t,i){e=i.item.offset().top,a=1.5*i.item.height()},stop:function(i,n){t=n.item.offset().top;var d=Math.trunc((t-e)/a),l=n.item.find(".ser_no");d>0?(l.val(parseInt(l.val())+d),SortChange("bigger",n.item.data("serno"),l.val()),n.item.data("serno",l.val())):d<0&&(l.val(parseInt(l.val())+d),SortChange("smaller",l.val(),n.item.data("serno")),n.item.data("serno",l.val()))}})})),$picker=$("#InputDate"),co.Picker.Init($picker),$picker.on("apply.daterangepicker",(function(e,t){$(this).val(t.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+t.endDate.format("YYYY/MM/DD HH:mm")),startDate=t.startDate.format(""),endDate=t.endDate.format("")}));const e=$("#ProductForm");Array.from(e).forEach((e=>{e.addEventListener("submit",(t=>{if(e.checkValidity())if(t.preventDefault(),ISpecRepect())co.sweet.error("錯誤","商品規格不可重複",null,!1);else{var a,i=!1;$(".input_price").each((function(){if(""==$(this).val())return i=!0,a=$(this),!1})),i?co.sweet.error("錯誤","請確實填寫價格",(function(){setTimeout((function(){$("html, body").animate({scrollTop:a.offset().top-2*$("header").height()},0)}),500)}),!1):Coker.sweet.confirm("即將發布","發布後將直接顯示於安排的位置","發布","取消",(function(){AddUp("已成功發布","發布發生未知錯誤","List")}))}else t.preventDefault(),t.stopPropagation();e.classList.add("was-validated")}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回商品列表","資料將不被保存","確定","取消",(function(){window.location.hash=""}))})),$(".btn_add").on("click",(function(){window.location.hash=0})),$(".btn_input_pic").on("click",(function(e){e.preventDefault(),$(".input_pic").click()})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$(".btn_expand_out").on("click",(function(){var e=$(this);"expand_less"==e.children("span").text()?e.children("span").text("expand_more"):e.children("span").text("expand_less")})),$(".btn_spec_add").on("click",(function(){SpecAdd(null)})),$(".btn_spec_price_add").on("click",(function(){SpecPriceAdd(null)})),$(".btn_price_save").on("click",SpecPriceSave),$name.on("keyup",(function(){$name_count.text($name.val().length)})),$introduction.on("keyup",(function(){$introduction_count.text($introduction.val().length)})),$illustrate.on("keyup",(function(){$illustrate_count.text($illustrate.val().length)})),$permanent.on("click",(function(){$permanent.is(":checked")?($date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null):$date.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3),$(".btn_to_canvas").on("click",(function(e){e.preventDefault(),Swal.fire({icon:"info",title:"前往內容編輯頁",html:"是否保存資料?",showCancelButton:!0,showDenyButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#888888",denyButtonColor:"#d33",confirmButtonText:"　是　",cancelButtonText:"　取消　",denyButtonText:"　否　",reverseButtons:!0}).then((e=>{if(e.isConfirmed)AddUp("已成功發布","發布發生未知錯誤","Canvas");else if(e.isDenied){var t=window.location.hash.replace("#","")+"-1";window.location.hash=t}}))}))}function ElementInit(){$btn_display=$("#Btn_Display"),$name=$("#InputName"),$name_count=$("#ProductForm > .name .name_count"),$introduction=$("#InputIntroduction"),$introduction_count=$("#ProductForm > .introduction .introduction_count"),$illustrate=$("#InputIllustrate"),$illustrate_count=$("#ProductForm > .illustrate .illustrate_count"),$marks=$("#InputMarks"),$spec_select=$(".spec_select"),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$date=$("#InputDate"),$permanent=$("#PermanentCheck"),priceModal=new bootstrap.Modal(document.getElementById("PriceModal")),$price_modal=$("#PriceModal >.modal-dialog > .modal-content > .modal-body >.price_option"),document.getElementById("PriceModal").addEventListener("hidden.bs.modal",(function(e){$price_modal.children(".frame").each((function(){$(this).remove(),spec_price_num=0})),$(".input_price").each((function(){var e=$(this),t=e.parents(".frame").data("psid"),a=e.parents(".frame").data("temppsid"),i=modal_price_list.findIndex((e=>e.FK_PSId==t||null!=e.TempPSid&&e.TempPSid==a));i>-1?(text="現金："+modal_price_list[i].Price+" 紅利："+modal_price_list[i].Bonus,e.val(text)):e.val("")})),$(".alert_text").addClass("d-none")}))}function FormDataClear(){TechCertDataClear(),TagDataClear(),$("#Spec_Frame > .frame").each((function(){$(this).remove()})),spec_num=0,keyId=0,$btn_display.children("span").text("visibility"),disp_opt=!0,$name.val(""),$name_count.text(0),$introduction.val(""),$introduction_count.text(0),$illustrate.val(""),$illustrate_count.text(0),$marks.val(""),$price.val(""),$stock_number.val(""),$alert_number.val(""),$min_number.val(""),$permanent.prop("checked",!1),$date.val(""),$date.removeAttr("disabled"),startDate=null,endDate=null,spec_remove_list=[],modal_price_list=[],price_tid=0,temp_psid=0,UploadPreviewFrameClear(),$("#ProductForm > .data_upload > ul").children(".upload_list").remove(),file_num=0,total_files=[]}function contentReady(e){product_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(FormDataClear(),""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");0==parseInt(e)?e.includes("-1")?MoveToCanvas():(SpecAdd(null),MoveToContent()):e.includes("-1")?MoveToCanvas():co.Product.Get.ProdOne(parseInt(e)).done((function(e){null!=e?co.Spec.GetPickSpecList().done((function(t){spec_pick_list=t,FormDataSet(e),MoveToContent()})):window.location.hash=""}))}}else BackToList()}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function paletteButtonClicked(e){keyId=e.row.key+"-1",window.location.hash=keyId}function FormDataSet(e){TagDataSet(e.tagDatas),TechCertDataSet(e.techCertDatas),e.files.forEach((e=>{UploadListAdd(e)})),e.stocks.forEach((function(e){e.prices.forEach((function(e){var t={};t.Id=e.id,t.Tempid=price_tid,t.FK_PSId=e.fK_PSId,t.TempPSid=0,t.FK_RId=e.fK_RId,t.Price=e.price,t.Bonus=e.bonus,t.IsDelete=!1,price_tid+=1,modal_price_list.push(t)})),SpecAdd(e)})),startDate=e.startTime,endDate=e.endTime,keyId=e.id,disp_opt=e.disp_Opt,$btn_display.children("span").text(e.disp_Opt?"visibility":"visibility_off"),$name.val(e.title),$name_count.text($name.val().length),$introduction.val(e.introduction),$introduction_count.text($introduction.val().length),$illustrate.val(e.description),$illustrate_count.text($illustrate.val().length),$date=$("#InputDate"),e.permanent?($date.val(""),$date.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate))}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Product.Delete.Prod(e.row.key).done((function(){product_list.component.refresh()})).fail((function(){Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)}))}))}function SpecPriceAdd(e){spec_price_num+=1;var t=$($("#ModalTemplatePrice").html()).clone(),a=t.find(".select_role"),i=t.find(".input_cash"),n=t.find(".input_bonus"),d=t.find(".btn_price_delete");t.data("ppid",null==e?0:e.Id),t.data("tempid",null==e?-1:e.Tempid),null!=e&&(a.val(e.FK_RId),i.val(e.Price),n.val(e.Bonus)),d.on("click",(function(){var e=$(this).parents(".frame").first();1==spec_price_num?co.sweet.error("商品至少需有一種價格",null,!1):co.sweet.confirm("移除價格","確定要移除此項價格嗎?","　是　","　否　",(function(){if(0==e.data("ppid")){if(e.data("tempid")>-1){var t=modal_price_list.findIndex((t=>t.Tempid==e.data("tempid")));modal_price_list[t].IsDelete=!0}}else{t=modal_price_list.findIndex((t=>t.Id==e.data("ppid")));modal_price_list[t].IsDelete=!0}spec_price_num-=1,e.remove()}))})),$("#PriceModal > .modal-dialog > .modal-content > .modal-body > .price_option").append(t),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function SpecPriceSave(){var e=[],t=!0;$price_modal.children(".frame").each((function(){$self=$(this);var a={};if(a.Id=$self.data("ppid"),a.Tempid=price_tid,a.FK_PSId=$self.parents(".modal-body").first().data("psid"),a.TempPSid=$self.parents(".modal-body").first().data("temppsid"),a.FK_RId=$self.find(".select_role").val(),a.Price=$self.find(".input_cash").val(),a.Bonus=$self.find(".input_bonus").val(),a.IsDelete=!1,0==a.Price&&0==a.Bonus)$(".alert_text").text("商品現金與紅利不可同時為空"),$(".alert_text").removeClass("d-none"),t=!1;else if(null!=e.find((e=>e.FK_RId==a.FK_RId&&e.Price==a.Price&&e.Bonus==a.Bonus)))$(".alert_text").removeClass("d-none"),$(".alert_text").text("價格不可重複"),t=!1;else if(e.push(a),$(".alert_text").addClass("d-none"),$self.data("tempid")<0)modal_price_list.push(a),price_tid+=1;else{var i=modal_price_list.findIndex((e=>e.Tempid==$self.data("tempid")));modal_price_list[i].FK_RId=$self.find(".select_role").val(),modal_price_list[i].Price=$self.find(".input_cash").val(),modal_price_list[i].Bonus=$self.find(".input_bonus").val()}})),t&&priceModal.hide()}function SpecAdd(e){spec_num+=1;var t=$($("#TemplateSpecification").html()).clone(),a=t.find(".topline"),i=t.find(".input_spec").first(),n=t.find(".input_spec").last(),d=t.find("datalist").first(),l=t.find("datalist").last(),o=t.find(".input_price"),s=t.find(".input_min_number"),r=t.find(".input_stock_number"),p=t.find(".input_alert_number"),c=t.find(".collapse"),u=t.find(".btn_expand"),f=t.find(".btn_delete");a.children(".spec").each((function(){var e=$($("#TemplateSpecType").html()).clone();$(this).prepend(e)}));var m=t.find(".spec_select").first(),_=t.find(".spec_select").last();if(null!=e&&null!=e.fK_ST1id&&(m.val(e.fK_ST1id),e.fK_ST1id>0)){m.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var e=$(this);e.val()==m.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),i.removeAttr("disabled");var v=spec_pick_list.find((e=>e.id==m.val()));v.specs.length>0&&v.specs.forEach((t=>{d.append(`<option value="${t.title}" data-sid="${t.id}"></option>`),t.id==e.fK_S1id&&(i.val(t.title),i.data("id",t.id))}))}if(null!=e&&null!=e.fK_ST2id&&(_.val(e.fK_ST2id),e.fK_ST2id>0)){_.parents(".spec").first().siblings(".spec").children(".spec_select").children("option").each((function(){var e=$(this);e.val()==_.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),n.removeAttr("disabled");v=spec_pick_list.find((e=>e.id==_.val()));v.specs.length>0&&v.specs.forEach((t=>{l.append(`<option value="${t.title}" data-sid="${t.id}"></option>`),t.id==e.fK_S2id&&(n.val(t.title),n.data("id",t.id))}))}null!=e?t.data("psid",e.id):(temp_psid+=1,t.data("temppsid",temp_psid));var h=modal_price_list.findIndex((e=>e.FK_PSId==t.data("psid")||null!=e.TempPSid&&e.TempPSid==t.data("temppsid")));h>-1?(text="現金："+modal_price_list[h].Price+" 紅利："+modal_price_list[h].Bonus,o.val(text)):o.val(""),s.val(null!=e?e.min_Qty:""),r.val(null!=e?e.stock:""),p.val(""),p.val(null!=e?e.alert_Qty:""),c.attr("id","CollapseDetail"+spec_num),u.attr("data-bs-target","#CollapseDetail"+spec_num),u.attr("aria-controls","CollapseDetail"+spec_num),i.attr("list","SpecListOpt"+spec_num+"-1"),n.attr("list","SpecListOpt"+spec_num+"-2"),d.attr("id","SpecListOpt"+spec_num+"-1"),l.attr("id","SpecListOpt"+spec_num+"-2"),o.on("click",(function(){var e=!0,t=$(this),a=t.parents(".frame").data("psid"),i=t.parents(".frame").data("temppsid");$price_modal.parents(".modal-body").first().data("psid",null!=a?a:""),$price_modal.parents(".modal-body").first().data("temppsid",null!=i?i:""),modal_price_list.forEach((function(t){(t.FK_PSId==a||null!=t.TempPsid&&t.TempPsid==i)&&(SpecPriceAdd(t),e=!1)})),e&&SpecPriceAdd(null),priceModal.show()})),null!=e&&(u.children("span").text("expand_more"),u.parents("div").first().prev().removeClass("show")),u.on("click",(function(){var e=$(this);"expand_less"==e.children("span").text()?e.children("span").text("expand_more"):e.children("span").text("expand_less")})),f.on("click",(function(){$self_p=$(this).parents(".frame").first(),1==spec_num?co.sweet.error("商品至少需有一種規格",null,!1):co.sweet.confirm("移除規格","確定要移除此項規格嗎?","　是　","　否　",(function(){spec_remove_list.push($self_p.data("psid")),spec_num-=1,$self_p.remove()}))})),$("#Spec_Frame").append(t),$spec_select=$(".spec_select"),$spec_select.each((function(){$self=$(this),$self.on("change",(function(){var t=$(this),a=t.parents(".spec").first().siblings(".spec"),i=t.siblings("datalist");if(e.val(""),i.children("option").each((function(){$(this).remove()})),a.children(".spec_select").children("option").each((function(){var e=$(this);e.removeAttr("disabled"),e.removeClass("bg-secondary-light25")})),0==t.val())e.attr("disabled","disabled");else{a.children(".spec_select").children("option").each((function(){var e=$(this);e.val()==t.val()&&(e.attr("disabled","disabled"),e.addClass("bg-secondary-light25"))})),e.removeAttr("disabled");var n=spec_pick_list.find((e=>e.id==t.val()));n.specs.length>0&&n.specs.forEach((e=>{i.append(`<option value="${e.title}" data-sid="${e.id}"></option>`)}))}}));var e=$self.siblings(".input_spec");e.blur((function(){var t,a;""!=e.val()&&(a=0,e.each((function(){$self_input=$(this),$self_input.siblings("datalist").children("option").each((function(){(t=$(this)).val()==$self_input.val()&&(a=t.data("sid"))}))})),0==a&&co.Spec.SpecAddUp({FK_Tid:e.prev("select").val(),Title:e.val()}).done((function(t){t.success&&co.Spec.GetPickSpecList().done((function(a){spec_pick_list=a,$self_input.siblings("datalist").append(`<option value="${e.val()}" data-sid="${t.message}"></option>`)}))})))}))})),$price=$(".input_price"),$stock_number=$(".input_stock_number"),$min_number=$(".input_min_number"),$alert_number=$(".input_alert_number"),$("input[type='number']").on("input",(function(){$(this).val($(this).val()<0?0:$(this).val())}))}function ISpecRepect(){var e=[],t=[],a=!1;return $("#Spec_Frame > .frame").each((function(){$self=$(this),$self.find(".input_spec").each((function(){e.push($(this).val())})),null!=t.find((t=>t[0]==e[0]&&t[1]==e[1]))?a=!0:(t.push(e),e=[])})),a}function UploadFile(e){UploadPreviewFrameClear();var t=e.parents(".data_upload").first();if(e.data("edit"))e.data("edit",!1),e.hasClass("upload_list")&&""==e.find(".title").text()&&(e.remove(),file_num-=1);else switch(e.hasClass("upload_list")&&""!=e.find(".title").text()&&$(".upload_list").each((function(){var t=$(this);t.hasClass("upload_list")&&""==t.find(".title").text()&&(t.remove(),file_num=e.siblings(".upload_list").length+1)})),upload_file=null,t.find(".upload_frame").children("*").remove(),$(".upload_list").each((function(){$(this).data("edit",!1)})),e.data("edit",!0),t.find(".default_frame").removeClass("d-flex"),e.data("uploadtype")){case 0:var a=t.find(".select_frame");a.addClass("d-flex"),a.find("button").each((function(){$(this).on("click",(function(t){t.preventDefault(),0==e.data("uploadtype")&&(e.data("uploadtype",$(this).data("uploadtype")),e.data("edit",!1),UploadFile(e))}))}));break;case 1:if(""==e.find(".title").text())upload_file=co.File.UploadImageInit("FileUpload"),t.find(".upload_frame").removeClass("d-none");else if(void 0!==e.data("id")){var i=total_files.find((t=>t.Id==e.data("id"))).Name,n=total_files.find((t=>t.Id==e.data("id"))).File;t.find(".media_frame").addClass("d-flex"),t.find(".media_frame").find("input").val(i),t.find(".media_preview > div").children().remove(),t.find(".media_preview > div").children().remove(),t.find(".media_preview > div").append(`<img src="${n}" class=""></img>`)}else if(void 0!==e.data("tempid")){if(void 0!==(l=total_files.find((t=>t.TempId==e.data("tempid"))))){t.find(".upload_frame").find("span").text(l.File.name),t.find(".media_frame").find("input").val(l.Name),t.find(".media_preview > div").children().remove();var d=l.Link;t.find(".media_preview > div").append(`<img src="${d}" class=""></img>`)}t.find(".media_frame").addClass("d-flex")}break;case 2:upload_file=co.File.Upload360Init("FileUpload"),e.data("file")&&(upload_file.addFiles(e.data("file")),t.find(".upload_frame").find("span").text(e.data("file").length+" 張圖片已選擇")),t.find(".upload_frame").removeClass("d-none");break;case 3:if(""==e.find(".title").text())upload_file=co.File.UploadVideoInit("FileUpload"),t.find(".upload_frame").removeClass("d-none");else if(void 0!==e.data("id")){i=total_files.find((t=>t.Id==e.data("id"))).Name,n=total_files.find((t=>t.Id==e.data("id"))).File;t.find(".media_frame").addClass("d-flex"),t.find(".media_frame").find("input").val(i),t.find(".media_preview > div").children().remove(),t.find(".media_preview > div").append(`<video src="${n}" class="h-100 w-100" controls preload="metadata"></video>`)}else if(void 0!==e.data("tempid")){var l;void 0!==(l=total_files.find((t=>t.TempId==e.data("tempid"))))&&(n=total_files.find((t=>t.TempId==e.data("tempid"))).File,t.find(".upload_frame").find("span").text(n.name),t.find(".media_frame").find("input").val(total_files.find((t=>t.TempId==e.data("tempid"))).Name)),t.find(".media_frame").addClass("d-flex")}break;case 4:if(void 0!==total_files.find((t=>t.Id==e.data("id")))){var o="https://www.youtube.com/watch?v="+(n=total_files.find((t=>t.Id==e.data("id"))).File);t.find(".youtube_frame").find("input").val(o),$("#BtnConnect").click()}else if(void 0!==total_files.find((t=>t.TempId==e.data("tempid")))){o="https://www.youtube.com/watch?v="+(n=total_files.find((t=>t.TempId==e.data("tempid"))).File);t.find(".youtube_frame").find("input").val(o),$("#BtnConnect").click()}else{t.find(".youtube_frame").find("input").val("https://www.youtube.com/watch?v=");$(".youtube_preview").children("*").remove(),$(".youtube_preview").append("<div class='w-100 h-100 d-flex justify-content-center align-items-center bg-black bg-opacity-25 fw-bold'>請輸入正確的Youtube連結</div>")}t.find(".youtube_frame").addClass("d-flex")}}function UploadListAdd(e){var t=$($("#TemplateUploadList").html()).clone(),a=t.find(".ser_no"),i=t.find(".btn_remove");if(null==e)$("#ProductForm > .data_upload > ul > li").each((function(){var e=$(this);e.hasClass("upload_list")&&""==e.find(".title").text()&&(e.remove(),file_num-=1)})),file_num+=1,t.data("tempid",file_num),t.data("serno",file_num),a.val(file_num),t.data("uploadtype",0),t.data("edit",!1),t.on("click",(function(){UploadFile($(this))}));else if(void 0===e.id)file_num+=1,t.data("tempid",e.TempId),t.data("serno",file_num),a.val(file_num),t.data("uploadtype",e.Type),t.data("edit",!1),t.find(".title").text(e.Name),t.on("click",(function(){UploadFile($(this))}));else{file_num+=1,t.data("id",e.id),t.data("serno",file_num),a.val(file_num),t.data("uploadtype",e.fileType),t.data("edit",!1),t.find(".title").text(e.name);var n={};n.Id=e.id,n.Name=e.name;var d=e.link[0];4==e.fileType?n.File=e.name:n.File=d,n.Type=e.fileType,n.IsDelete=!1,total_files.push(n),t.on("click",(function(){UploadFile($(this))}))}a.blur((function(){var e=$(this);e.val()<1?e.val(1):e.val()>$(".upload_list").length&&e.val($(".upload_list").length),e.val()!=t.data("serno")&&(e.val()>t.data("serno")?(SortChange("bigger",t.data("serno"),e.val()),$("#ProductForm > .data_upload > ul").children("li").eq(parseInt(e.val())-1).after(t)):e.val()<t.data("serno")&&(SortChange("smaller",e.val(),t.data("serno")),$("#ProductForm > .data_upload > ul").children("li").eq(parseInt(e.val())-1).before(t))),t.data("serno",e.val())})),i.on("click",(function(e){e.preventDefault();var a=$(this).parents("li").first();if(t.data("serno")<file_num&&SortChange("bigger",t.data("serno"),file_num),void 0!==a.data("id"))total_files.find((e=>e.Id==a.data("id"))).IsDelete=!0;else if(void 0!==a.data("tempid")){var i=a.data("tempid"),n=total_files.findIndex((e=>e.TempId==i));total_files.splice(n,1),total_files.forEach((e=>{e.TempId=e.TempId>i?e.TempId-1:e.TempId}))}UploadPreviewFrameClear(),a.remove(),file_num-=1})),$("#ProductForm > .data_upload > ul > .btn_upload_add").before(t),UploadFile(t)}function UploadPreviewFrameClear(){var e=$("#ProductForm > .data_upload > .preview_frame");e.find(".default_frame").addClass("d-flex"),e.find(".upload_frame").addClass("d-none"),e.find(".media_frame").removeClass("d-flex"),e.find(".youtube_frame").removeClass("d-flex"),e.find(".select_frame").removeClass("d-flex")}function SortChange(e,t,a){$(".upload_list").each((function(){var i=$(this);"bigger"==e?i.data("serno")>t&&i.data("serno")<=a&&(i.find(".ser_no").val(parseInt(i.data("serno"))-1),i.data("serno",i.find(".ser_no").val())):"smaller"==e&&i.data("serno")>=t&&i.data("serno")<a&&(i.find(".ser_no").val(parseInt(i.data("serno"))+1),i.data("serno",i.find(".ser_no").val()))}))}function AddUp(e,t,a){var i=[],n=1;$("#Spec_Frame > .frame").each((function(){var e=$(this),t={},a=[];e.find(".input_spec").each((function(){var e=0;$self_input=$(this),$self_input.siblings("datalist").children("option").each((function(){var t=$(this);t.val()==$self_input.val()&&(e=t.data("sid"))})),a.push(e)})),t.Id=""==e.data("psid")?0:e.data("psid"),t.FK_S1id=a[0],t.FK_S2id=a[1],t.Stock=e.find(".input_stock_number").val(),t.Alert_Qty=e.find(".input_alert_number").val(),t.Min_Qty=e.find(".input_min_number").val(),t.Ser_No=n,n++;var d=[];modal_price_list.forEach((function(t){if(t.FK_PSId==e.data("psid")||t.TempPSid==e.data("temppsid")){var a={};a.Id=t.Id,a.FK_PSId=t.FK_PSId,a.FK_RId=t.FK_RId,a.Price=t.Price,a.Bonus=t.Bonus,a.IsDelete=t.IsDelete,d.push(a)}})),t.Prices=d,i.push(t)})),co.Product.AddUp.Product({Id:keyId,Title:$name.val(),Disp_Opt:disp_opt,Ser_No:500,Introduction:$introduction.val(),Description:$illustrate.val(),StartTime:startDate,EndTime:endDate,Permanent:$permanent.is(":checked"),TagSelected:tag_list,TechCertSelected:techcert_list,Stocks:i}).done((function(i){var n=parseInt(i.message);i.success?total_files.length>0?($("#ProductForm > .data_upload > ul > li").each((function(){var e=$(this);if(!e.hasClass("btn_upload_add")){var t=[];switch(total_files.forEach((a=>{(void 0!==a.Id&&a.Id==e.data("id")||void 0!==a.TempId&&a.TempId==e.data("tempid"))&&t.push(a)})),t[0].Type){case 1:if("string"==typeof t[0].File)co.File.fileSortChange({Id:t[0].Id,SerNo:e.find(".ser_no").val()});else(d=new FormData).append("type",1),d.append("sid",n),d.append("serno",e.find(".ser_no").val()),t.forEach((e=>{for(var t=0;t<e.File.length;t++)d.append("files",e.File[t]);co.File.Upload(d),d.delete("files")}));break;case 2:(d=new FormData).append("type",1),d.append("sid",n),d.append("serno",e.find(".ser_no").val());for(var a=0;a<t.length;a+=3){for(var i=a;i<a+3;i++)d.append("files",t[i]);d.delete("files")}break;case 3:var d;if("string"==typeof t[0].File)co.File.fileSortChange({Id:t[0].Id,SerNo:e.find(".ser_no").val()});else(d=new FormData).append("files",t[0].File),d.append("type",1),d.append("sid",n),d.append("serno",e.find(".ser_no").val()),co.File.Upload(d);break;case 4:var l=void 0===t[0].Id?0:t[0].Id;co.File.UploadYTLink({Id:l,File:t[0].File+"",SId:n,Type:1,SerNo:e.find(".ser_no").val()})}}})),total_files.forEach((e=>{if(void 0!==e.IsDelete&&1==e.IsDelete)switch(e.Type){case 2:break;case 1:case 3:case 4:if(void 0!==e.Id){var t=[];t.add(e.Id),co.File.DeleteFileById({Sid:parseInt(i.message),Type:1,Fid:t})}}})),"List"==a?(Coker.sweet.success(e,null,!0),setTimeout((function(){BackToList(),product_list.component.refresh()}),1e3)):"Canvas"==a&&(Coker.sweet.success(e,null,!0),setTimeout((function(){var e=window.location.hash.replace("#","")+"-1";window.location.hash=e}),1e3))):"List"==a?(Coker.sweet.success(e,null,!0),setTimeout((function(){BackToList(),product_list.component.refresh()}),1e3)):"Canvas"==a&&(Coker.sweet.success(e,null,!0),setTimeout((function(){var e=window.location.hash.replace("#","")+"-1";window.location.hash=e}),1e3)):Coker.sweet.error("錯誤",t,null,!0)})).fail((function(){Coker.sweet.error("錯誤",t,null,!0)})),spec_remove_list.length>0&&spec_remove_list.forEach((function(e){co.Product.Delete.Stock(e)}))}function MoveToContent(){0==keyId?$("#ProductContent .card-header .titile").text("新增商品"):$("#ProductContent .card-header .titile").text("編輯商品"),$("#ProductForm").removeClass("was-validated"),$("#ProductList").addClass("d-none"),$("#ProductCanvas").addClass("d-none"),$("#ProductContent").removeClass("d-none")}function MoveToCanvas(){$("#ProductList").addClass("d-none"),$("#ProductContent").addClass("d-none"),$("#ProductCanvas").removeClass("d-none")}function BackToList(){$("#ProductList").removeClass("d-none"),$("#ProductCanvas").addClass("d-none"),$("#ProductContent").addClass("d-none"),window.location.hash=""}