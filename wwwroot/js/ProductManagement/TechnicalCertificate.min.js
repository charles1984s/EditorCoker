var $btn_input_pic,$btn_img_delete,$btn_display,$title,$illustrate,$illustrate_count,$input_sort,$check_sort,$date,$permanent,$input_pic,$img_preview,startDate,endDate,keyId,technicalCertificate_list,disp_opt=!0,img_file=[],img_start_index=null,img_delete_list=[];function PageReady(){co.TechnicalCertificate={AddUp:function(e){return $.ajax({url:"/api/TechnicalCertificate/AddUp",type:"POST",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:JSON.stringify(e),dataType:"json"})},Get:function(e){return $.ajax({url:"/api/TechnicalCertificate/GetOne/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{id:e}})},Delete:function(e){return $.ajax({url:"/api/TechnicalCertificate/Delete/",type:"GET",contentType:"application/json; charset=utf-8",headers:_c.Data.Header,data:{Id:e}})}},ElementInit(),co.Picker.Init($picker),$picker.on("apply.daterangepicker",(function(e,t){$(this).val(t.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+t.endDate.format("YYYY/MM/DD HH:mm")),startDate=t.startDate.format(""),endDate=t.endDate.format("")}));const e=$("#TechnicalCertificateForm");Array.from(e).forEach((e=>{e.addEventListener("submit",(t=>{e.checkValidity()?null==img_file?Coker.sweet.error("尚未上傳證照圖片","請上傳一張圖片"):(t.preventDefault(),Coker.sweet.confirm("即將發布","發布後將直接顯示於安排的位置","發布","取消",(function(){AddUp(disp_opt,"已成功發布","發布發生未知錯誤")}))):(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated"),WasValidated()}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回技術證照列表","資料將不被保存","確定","取消",(function(){history.back()}))})),$(".btn_add").on("click",(function(){FormDataClear(),window.location.hash=0,HashDataEdit()})),$(".btn_expand").on("click",(function(){var e=$(this);"expand_more"==e.children("span").text()?e.children("span").text("expand_less"):e.children("span").text("expand_more")})),$btn_input_pic.on("click",(function(e){e.preventDefault();var t=$(this);img_start_index=null!=t.data("index")?3*(parseInt(t.data("index"))-1):null,t.prev(".input_pic").click()})),$input_pic.change((function(){null==img_start_index?uploadImage(this.files[0]):reuploadImage(this.files[0])})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$illustrate.on("keyup",(function(){$illustrate_count.text($illustrate.val().length)})),$check_sort.on("click",(function(){$check_sort.is(":checked")?$input_sort.removeAttr("disabled"):($input_sort.val(""),$input_sort.attr("disabled","disabled"))})),$permanent.on("click",(function(){$permanent.is(":checked")?($date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null):$date.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function ElementInit(){$picker=$("#InputDate"),$btn_input_pic=$(".btn_input_pic"),$btn_img_delete=$(".btn_img_delete"),$input_pic=$(".input_pic"),$img_preview=$(".img_preview"),$btn_display=$("#Btn_Display"),$title=$("#InputTitle"),$illustrate=$("#InputIllustrate"),$illustrate_count=$("#TechnicalCertificateForm > .illustrate .illustrate_count"),$input_sort=$("#InputSort"),$check_sort=$("#SortCheck"),$date=$("#InputDate"),$permanent=$("#PermanentCheck")}function contentReady(e){technicalCertificate_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");0==parseInt(e)?(FormDataClear(),MoveToContent()):co.TechnicalCertificate.Get(parseInt(e)).done((function(e){MoveToContent(),null!=e?co.File.getImgFile({Sid:e.id,Type:4,Size:3}).done((function(t){FormDataSet(e,t)})):window.location.hash=""}))}}else BackToList()}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function FormDataSet(e,t){if(FormDataClear(),keyId=e.id,startDate=e.startDate,endDate=e.endDate,$btn_display.children("span").text(e.disp_opt?"visibility":"visibility_off"),disp_opt=e.disp_opt,$title.val(e.title),500!=e.ser_no&&($check_sort.prop("checked",!0),$input_sort.removeAttr("disabled","disabled"),$input_sort.val(e.ser_no)),$illustrate.val(e.description),$illustrate_count.text($illustrate.val().length),e.permanent?($date.val(""),$date.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate)),null!=t)for(var i=0;i<t.length;i++){var n=$($("#Template_Image_Preview").html()).clone(),a=n.find(".btn_input_pic"),l=n.find(".btn_img_delete"),r=n.find(".input_pic"),s=n.find("img"),c=n.find(".img_name");a.data("id",t[i].id),c.text(t[i].name),s.attr("src",t[i].link),$("#TechnicalCertificateForm > div > .img_input_frame").prepend(n),a.on("click",(function(e){e.preventDefault();var t=$(this);0!=t.data("id")&&(img_delete_list.push(parseInt(t.data("id"))),t.data("id",0)),null!=t.data("index")&&""!=t.data("index")||t.data("index",img_file.length/3+1),img_start_index=3*(parseInt(t.data("index"))-1),t.parents("div").first().siblings(".input_pic").click()})),l.on("click",(function(e){e.preventDefault();var t=$(this).siblings(".btn_input_pic");img_delete_list.push(parseInt(t.data("id"))),$(this).parents("div").first().parents("div").first().remove()})),r.change((function(){null==img_start_index?uploadImage(this.files[0]):reuploadImage(this.files[0],$(this))}))}}function FormDataClear(){keyId=0,$btn_display.children("span").text("visibility"),disp_opt=!0,$title.val(""),$illustrate.val(""),$illustrate_count.text(0),$input_sort.val(""),$input_sort.attr("disabled","disabled"),$check_sort.prop("checked",!1),$permanent.prop("checked",!0),$date.val(""),$date.attr("disabled","disabled"),startDate=null,endDate=null,$("#TechnicalCertificateForm > div > .img_input_frame").children("div").each((function(){$(this).siblings().length>1&&$(this).remove()})),img_file=[],img_start_index=null}function uploadImage(e){img_file.push(e);var t=$($("#Template_Image_Preview").html()).clone(),i=t.find(".btn_input_pic"),n=t.find(".btn_img_delete"),a=t.find(".input_pic"),l=t.find("img"),r=t.find(".img_name");img_start_index=img_file.length-1,r.text(img_file[img_start_index].name),i.data("index",img_start_index/3+1),new HtmlImageCompress(img_file[img_start_index],{quality:.7}).then((function(e){img_file.push(new File([e.file],img_file[img_start_index].name))})).catch((function(e){console.log($`發生錯誤：${e}`)})),new HtmlImageCompress(img_file[img_start_index],{quality:.3}).then((function(e){img_file.push(new File([e.file],img_file[img_start_index].name));var t=new FileReader;t.readAsDataURL(img_file[img_start_index+2]),t.onload=function(e){l.attr("src",e.target.result)}})).catch((function(e){console.log($`發生錯誤：${e}`)})),$("#TechnicalCertificateForm > div > .img_input_frame").prepend(t),i.on("click",(function(e){e.preventDefault();var t=$(this);img_start_index=null!=t.data("index")?3*(parseInt(t.data("index"))-1):null,t.prev(".input_pic").click()})),n.on("click",(function(e){e.preventDefault();var t=$(this).siblings(".btn_input_pic");img_delete_list.push(parseInt(t.data("id"))),$(this).parents("div").first().parents("div").first().remove()})),a.change((function(){null==img_start_index?uploadImage(this.files[0]):reuploadImage(this.files[0],$(this))}))}function reuploadImage(e,t){img_file[img_start_index]=e,t.siblings(".img_name").text(img_file[img_start_index].name),new HtmlImageCompress(img_file[img_start_index],{quality:.7}).then((function(e){img_file[img_start_index+1]=new File([e.file],img_file[img_start_index].name)})).catch((function(e){console.log($`發生錯誤：${e}`)})),new HtmlImageCompress(img_file[img_start_index],{quality:.3}).then((function(e){img_file[img_start_index+2]=new File([e.file],img_file[img_start_index].name);var i=new FileReader;i.readAsDataURL(img_file[img_start_index+2]),i.onload=function(e){t.next("div").children(".btn_input_pic").children("img").attr("src",e.target.result)}})).catch((function(e){console.log($`發生錯誤：${e}`)}))}function DeleteImage(){}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.TechnicalCertificate.Delete(e.row.key).done((function(t){t.success?e.component.refresh():Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)})).fail((function(){Coker.sweet.error("錯誤","刪除資料發生錯誤",null,!0)}))}))}function AddUp(e,t,i){co.TechnicalCertificate.AddUp({Id:keyId,TId:$.cookie("secret"),Disp_opt:e,Img:"",Title:$title.val(),Description:$illustrate.val(),Ser_no:$check_sort.is(":checked")?$input_sort.val():500,StartDate:startDate,EndDate:endDate,permanent:$permanent.is(":checked")}).done((function(e){if(e.success)if(img_delete_list.length>0&&img_delete_list.forEach((function(t){var i=[];i.add(t),co.File.DeleteFileById({Sid:e.message,Type:4,Fid:i}).done((function(e){}))})),img_file.length>0){var n=new FormData;n.append("type",4),n.append("sid",e.message);for(var a=0;a<img_file.length;a+=3){for(var l=a;l<a+3;l++)n.append("files",img_file[l]);co.File.Upload(n).done((function(e){e.success?(Coker.sweet.success(t,null,!0),setTimeout((function(){BackToList(),FormDataClear(),technicalCertificate_list.component.refresh()}),1e3)):Coker.sweet.error("錯誤",i,null,!0)})),n.delete("files")}}else Coker.sweet.success(t,null,!0),setTimeout((function(){BackToList(),FormDataClear(),technicalCertificate_list.component.refresh()}),1e3);else Coker.sweet.error("錯誤",i,null,!0)})).fail((function(){Coker.sweet.error("錯誤",i,null,!0)}))}function MoveToContent(){UnValidated(),$("#TechnicalCertificateList").addClass("d-none"),$("#TechnicalCertificateContent").removeClass("d-none")}function BackToList(){$("#TechnicalCertificateList").removeClass("d-none"),$("#TechnicalCertificateContent").addClass("d-none"),window.location.hash=""}function WasValidated(){$(".icon_hint").addClass("pe-4"),$check_sort.parents(".checkbox").first().addClass("pe-4"),$permanent.parents(".checkbox").first().addClass("pe-4")}function UnValidated(){$("#TechnicalCertificateForm").removeClass("was-validated"),$(".icon_hint").removeClass("pe-4"),$check_sort.parents(".checkbox").first().removeClass("pe-4"),$permanent.parents(".checkbox").first().removeClass("pe-4")}