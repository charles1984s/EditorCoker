var $btn_display,$btn_pop_visible,$title,$title_text,$describe,$describe_text,$sort,$sort_input,$sort_checkbox,$picker,$nodeDate,$permanent,startDate,endDate,keyId,article_list,initTag_list,setPage,initPageData,disp_opt=!1,pop_visible=!1;function PageReady(){const e=grapesInit({save:function(e,t){var n=$.Deferred();return co.Articles.SaveConten({Id:$("#gjs").data("id"),SaveHtml:e,SaveCss:t}).done((function(e){e.success?n.resolve():co.sweet.error(e.error)})),n.promise()},import:function(e,t){var n=$.Deferred();return co.Articles.ImportConten({Id:$("#gjs").data("id"),SaveHtml:e,SaveCss:t}).done((function(e){e.success?n.resolve():co.sweet.error(e.error)})),n.promise()},getComponer:function(){var e=$.Deferred();return co.HtmlContent.GetAllComponent().done((function(t){t.success?e.resolve(t.list):co.sweet.error(resutlt.error)})),e.promise()}});setPage=function(t){co.Articles.GetConten({Id:t}).done((function(t){if(t.success){""==t.conten.saveHtml&&(t.conten.saveHtml=initPageData.html,t.conten.saveCss=initPageData.css);var n=co.Data.HtmlDecode(t.conten.saveHtml);$("body").addClass("grapesEdit"),setTimeout((function(){e.setStyle(t.conten.saveCss),e.setComponents(n)}),300),t.title&&$("#TopLine .title").text(t.title)}else co.sweet.error(t.error)}))},ImageUploadModalInit($("#ImageUpload")),ElementInit(),TagListModalInit(),co.Recipient.GetRecipientsTag().done((function(e){initTag_list=[],null!=e&&initTag_list.push(e)})),co.ObjectType.GetNewsletterConten().done((function(e){e.success&&(initPageData=e.conten),console.log(initPageData)}));const t=$("#ArticletForm");Array.from(t).forEach((e=>{e.addEventListener("submit",(t=>{e.checkValidity()?(t.preventDefault(),Coker.sweet.confirm("即將儲存","儲存後將顯示於安排的位置","儲存","取消",(function(){AddUp("已成功儲存","儲存發生未知錯誤")}))):(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated"),WasValidated()}),!1)})),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回電子報列表","資料將不被保存","確定","取消",(function(){article_list.component.refresh(),BackToList()}))})),$(".btn_add").on("click",(function(){FormDataClear(),window.location.hash=0,HashDataEdit()})),$(".btn_to_canvas").on("click",(function(e){e.preventDefault(),Swal.fire({icon:"info",title:"前往電子報編輯頁",html:"是否保存資料?",showCancelButton:!0,showDenyButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#888888",denyButtonColor:"#d33",confirmButtonText:"　是　",denyButtonText:"　否　",cancelButtonText:"　取消　",reverseButtons:!0}).then((e=>{if(e.isConfirmed)AddUp("資料已儲存","儲存發生未知錯誤","canvas");else if(e.isDenied){var t=window.location.hash.replace("#","")+"-1";window.location.hash=t,MoveToCanvas()}}))})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$btn_pop_visible.on("click",(function(){pop_visible?($btn_pop_visible.children("span").text("group_off"),pop_visible=!pop_visible):($btn_pop_visible.children("span").text("group"),pop_visible=!pop_visible)})),$title_text.on("keyup",(function(){var e=$(this);$title.children("div").children(".count").text(e.val().length)})),$describe_text.on("keyup",(function(){var e=$(this);$describe.children("div").children(".count").text(e.val().length)})),$sort_checkbox.on("click",(function(){$(this).is(":checked")?$sort_input.removeAttr("disabled"):($sort_input.val(""),$sort_input.attr("disabled","disabled"))})),co.Picker.Init($picker),co.Picker.Init($nodeDate,{singleDatePicker:!0,timePicker:!1,locale:{format:"YYYY/MM/DD"}}),$picker.on("apply.daterangepicker",(function(e,t){$(this).val(t.startDate.format("YYYY/MM/DD HH:mm")+" ~ "+t.endDate.format("YYYY/MM/DD HH:mm")),startDate=t.startDate.format(""),endDate=t.endDate.format("")})),$permanent.on("click",(function(){$permanent.is(":checked")?($picker.val(""),$picker.attr("disabled","disabled"),startDate=null,endDate=null):$picker.removeAttr("disabled")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function ElementInit(){$btn_display=$(".btn_display"),$btn_pop_visible=$(".btn_pop_visible"),$title=$(".title"),$title_text=$title.children("textarea"),$describe=$(".describe"),$describe_text=$describe.children("textarea"),$sort=$(".sort"),$sort_input=$sort.children("input"),$sort_checkbox=$sort.children(".checkbox").children("input"),$picker=$("#InputDate"),$nodeDate=$("#NodeDate"),$permanent=$("#PermanentCheck")}function contentReady(e){article_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");0==parseInt(e)?(window.location.hash=0,keyId=0,FormDataClear(),MoveToContent()):co.Articles.GetDataOne(parseInt(e)).done((function(t){null!=t?(keyId=parseInt(e),e.indexOf("-")>0?MoveToCanvas():(MoveToContent(),FormDataSet(t))):(window.location.hash="",keyId="")}))}}else BackToList()}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function FormDataClear(){TagDataClear(),ImageUploadModalClear($("#ImageUpload")),keyId=0,$btn_display.children("span").text("visibility_off"),$btn_pop_visible.children("span").text("group_off"),$title_text.val(""),$title.children("div").children(".count").text(0),$describe_text.val(""),$describe.children("div").children(".count").text(0),$sort_input.val(""),$sort_input.attr("disabled","disabled"),$sort_checkbox.prop("checked",!1),$permanent.prop("checked",!0),TagInitSet(initTag_list),pop_visible=!1,disp_opt=!1}function FormDataSet(e){FormDataClear(),co.File.getImgFile({Sid:e.id,Type:6,Size:3}).done((function(e){ImageUploadModalDataInsert($("#ImageUpload"),e[0].id,e[0].link,e[0].name)})),keyId=e.id,e.visible&&$btn_display.children("span").text("visibility"),e.popularVisible&&$btn_pop_visible.children("span").text("group"),$title_text.val(e.title),$title.children("div").children(".count").text(e.title.length),$describe_text.val(e.description),$describe.children("div").children(".count").text(e.description.length),$nodeDate.val(e.nodeDate),startDate=e.startTime,endDate=e.endTime,pop_visible=e.popularVisible,disp_opt=e.visible,500!=e.serNO&&($sort_input.val(e.serNO),$sort_input.removeAttr("disabled"),$sort_checkbox.prop("checked",!0)),e.permanent?($picker.val(""),$picker.attr("disabled","disabled"),$permanent.prop("checked",!0)):(null!=startDate&&$picker.data("daterangepicker").setStartDate(startDate),null!=endDate&&$picker.data("daterangepicker").setEndDate(endDate),$permanent.prop("checked",!1)),null!=e.nodeDate&&($nodeDate.data("daterangepicker").setStartDate(e.nodeDate),$nodeDate.data("daterangepicker").setEndDate(e.nodeDate)),TagDataSet(e.tagDatas)}function paletteButtonClicked(e){keyId=e.row.key,window.location.hash=keyId+"-1"}function sendButtonClicked(e){const t=e.row.key;co.sweet.confirm("是否確認發送電子報","電子報將會寄送給所有收件人","寄出","取消",(function(){co.Newsletter.send(t).done((e=>{e.success?co.sweet.success("寄送成功"):co.sweet.error("傳送失敗",e.error)}))}))}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Articles.Delete(e.row.key).done((function(t){t.success&&e.component.refresh()}))}))}function AddUp(e,t,n){null!=$("#ImageUpload .img_input_frame").data("delectList")&&co.File.DeleteFileById({Sid:keyId,Type:6,Fid:$("#ImageUpload").data("delectList")}),co.Articles.AddUp({Id:keyId,Title:$title_text.val(),Description:$describe_text.val(),Visible:disp_opt,SerNO:$sort_checkbox.is(":checked")?$sort_input.val():500,PopularVisible:pop_visible,TagSelected:tag_list,permanent:$permanent.is(":checked"),StartTime:startDate,EndTime:endDate,NodeDate:$nodeDate.val()}).done((function(i){if(i.success)if(null!=$("#ImageUpload .img_input").data("file")&&null!=$("#ImageUpload .img_input").data("file").File&&0==$("#ImageUpload .img_input").data("file").Id){var a=new FormData;a.append("files",$("#ImageUpload .img_input").data("file").File),a.append("type",6),a.append("sid",i.message),a.append("serno",500),co.File.Upload(a).done((function(t){t.success&&(Coker.sweet.success(e,null,!0),setTimeout((function(){"canvas"==n?setTimeout((function(){0==keyId?window.location.hash=`${i.message}-1`:window.location.hash+="-1"}),1e3):setTimeout((function(){article_list.component.refresh(),BackToList()}),1e3)}),1e3))}))}else Coker.sweet.success(e,null,!0),setTimeout((function(){"canvas"==n?setTimeout((function(){0==keyId?window.location.hash=`${i.message}-1`:window.location.hash+="-1"}),1e3):setTimeout((function(){article_list.component.refresh(),BackToList()}),1e3)}),1e3);else Coker.sweet.error("錯誤",t,null,!0)})).fail((function(){Coker.sweet.error("錯誤",t,null,!0)}))}function MoveToContent(){UnValidated(),$("#ArticleList").addClass("d-none"),$("#ArticleContent").removeClass("d-none"),$("#ArticleCanvas").addClass("d-none"),$("body").removeClass("grapesEdit")}function MoveToCanvas(){UnValidated(),$("#gjs").data("id",keyId),setPage(keyId),$("#TopLine > div > a").removeClass("d-none"),$("#ArticleList").addClass("d-none"),$("#ArticleContent").addClass("d-none"),$("#ArticleCanvas").removeClass("d-none")}function BackToList(){$("#TopLine > div > a").addClass("d-none"),$("#ArticleList").removeClass("d-none"),$("#ArticleContent").addClass("d-none"),$("#ArticleCanvas").addClass("d-none"),$("body").removeClass("grapesEdit"),$("#TopLine .title").text("電子報管理"),window.location.hash=""}function WasValidated(){$sort.children(".checkbox").addClass("pe-4")}function UnValidated(){$("#ArticletForm").removeClass("was-validated"),$sort.children(".checkbox").removeClass("pe-4")}