var $btn_display,title,$title_text,$description,$description_text,$ad_type,keyId,disp_opt=!0,DirectoryId=0,DirectoryType="n";let directory_list,editor,permissionDetailsModal,DirectoryForms,$DirectoryTags,AdvertiseForms,$AdvertiseTags;function PageReady(){DirectoryForms=$("#DirectoryForm"),AdvertiseForms=$("#AdvertiseForm"),permissionDetailsModal=new bootstrap.Modal(document.getElementById("PermissionDetailsModal")),co.PowerManagement.GetPermission().done((function(e){e.CanCreate||$(".btn_add").remove()})),ElementInit(),$(".btn_input_pic").on("click",(function(e){e.preventDefault(),$(".input_pic").click()})),$(".btn_input_video").on("click",(function(e){e.preventDefault(),$(".input_video").click()})),$(".input_pic").on("change",(function(e){var t=e.target.files[0],i=new FileReader;i.readAsDataURL(t),i.onload=function(e){var i={id:0};i.File=t,i.name=t.name,i.link=e.target.result,$(".img_preview").attr("src",e.target.result),$(".btn_input_pic > span").addClass("d-none"),$(".img_preview").removeClass("d-none"),$ad_type.data("file",i)}})),$(".input_video").on("change",(function(e){var t=e.target.files[0],i=new FileReader;i.readAsDataURL(t),i.onload=function(e){var i={id:0};i.File=t,i.name=t.name,i.link=e.target.result,$(".video_preview").attr("type",i.File.type),$(".video_preview").attr("src",i.link),$ad_type.data("file",i)}})),$DirectoryTags=$(DirectoryForms).find(".InputTag").TagListModalInit(),$AdvertiseTags=$(AdvertiseForms).find(".InputTag").TagListModalInit(),Array.from(AdvertiseForms).forEach((e=>{e.addEventListener("submit",(t=>{e.checkValidity()?(t.preventDefault(),Coker.sweet.confirm("即將儲存","儲存後將顯示於廣告列表","儲存","取消",(function(){AddUpAdvertise("已成功儲存","儲存發生未知錯誤")}))):(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")}),!1)})),Array.from(DirectoryForms).forEach((e=>{e.addEventListener("submit",(t=>{e.checkValidity()?(t.preventDefault(),""==$("#InputTag").val()||"無"==$("#InputTag").val()?Coker.sweet.error("錯誤","標籤不可為空",null,!1):Coker.sweet.confirm("即將儲存","儲存後將顯示於安排的位置","儲存","取消",(function(){AddUp("已成功儲存","儲存發生未知錯誤")}))):(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")}),!1)})),$("#DirectoryContent .btn_back").on("click",(function(){Coker.sweet.confirm("返回目錄列表","資料將不被保存","確定","取消",(function(){directory_list.component.refresh(),BackToList()}))})),$("#AdvertiseContent .btn_back").on("click",(function(){const e=$("#DirectoryItemps").data("dir");Coker.sweet.confirm(`返回${e.title}廣告列表`,"資料將不被保存","確定","取消",(function(){directoryDatailList.component.refresh(),$ad_type.data("fileid",0),$ad_type.val(null),$ad_type.change(),location.hash=`Advertise_${e.id}`}))})),$("#DirectoryList .btn_add").on("click",(function(){FormDataClear(),window.location.hash=0,HashDataEdit()})),$("#DirectoryItemps .btn_add").on("click",(function(){window.location.hash=`AdvertiseEditor_${DirectoryId}_0`})),$("#DirectoryItemps .btn_back").off("click").on("click",(function(){BackToList()})),$(".btn_preview").off("click").on("click",(function(){$(".ad_preview > div").each((function(e){$(this).addClass("d-none")})),$(".ad_preview > .youtube").removeClass("d-none");var e=$(".btn_preview").prev().val(),t=e.substr(e.indexOf("v=")+2);$ad_type.data("file",t);var i="https://www.youtube-nocookie.com/embed/"+t;$(".ad_preview > .youtube > iframe").attr("src",i)})),$btn_display.on("click",(function(){disp_opt?($btn_display.children("span").text("visibility_off"),disp_opt=!disp_opt):($btn_display.children("span").text("visibility"),disp_opt=!disp_opt)})),$title_text.on("keyup",(function(){var e=$(this);$title.children("div").children(".count").text(e.val().length)})),$description_text.on("keyup",(function(){var e=$(this);$description.children("div").children(".count").text(e.val().length)})),$ad_type.on("change",(function(){switch(FileTypeInit(),parseInt($ad_type.val())){case 1:ImageTypeInit();break;case 2:VideoTypeInit();break;case 3:YoutubeTypeInit()}})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function ElementInit(){$ad_type=$("#AdType"),$btn_display=$(".btn_display"),$title=$(".title"),$title_text=$title.children("textarea"),$description=$(".description"),$description_text=$description.children("textarea")}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");if(e&&isNaN(e))if(e.indexOf("Editor")>-1)MoveToItemAdvertise();else{let e=null;const t=function(){clearTimeout(e),null!=directoryDatailList?MoveToItemList():e=setTimeout(t,100)};t()}else 0==parseInt(e)?(window.location.hash=0,keyId=0,FormDataClear(),MoveToContent()):(MoveToContent(),co.Directory.Get(parseInt(e)).done((function(e){null!=e?(MoveToContent(),FormDataSet(e)):(window.location.hash="",keyId="")})))}}else BackToList()}function contentReady(e){directory_list=e,HashDataEdit()}function DirectoryDatailListReady(e){directoryDatailList=e}function editButtonClicked(e){MoveToContent(),keyId=e.row.key,window.location.hash=keyId}function reladataButtonClicked(e){keyId=`Advertise_${e.row.key}`,window.location.hash=keyId}function GetDirectoryId(){return DirectoryId}function GetDirectoryType(){return DirectoryType}function deleteButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Directory.Delete(e.row.key).done((function(t){t.success&&e.component.refresh()})),e.component.refresh()}))}function FormDataClear(){$DirectoryTags.TagDataClear(),keyId=0,$btn_display.children("span").text("visibility"),$title_text.val(""),$description_text.val(""),$("#SortBy").val(0)}function FormDataSet(e){console.log(e),FormDataClear(),keyId=e.id,disp_opt=e.visible,$("#SortBy").val(e.sortBy),disp_opt?$btn_display.children("span").text("visibility"):$btn_display.children("span").text("visibility_off"),$DirectoryTags.TagDataSet(e.tagDatas),$title_text.val(e.title),$description_text.val(e.description)}function AddUp(e,t){co.Directory.AddUp({Id:keyId,Title:$title_text.val(),Description:$description_text.val(),Type:4,Visible:disp_opt,TagSelected:$DirectoryTags.data("tagList"),SortBy:$("#SortBy").val()}).done((function(){Coker.sweet.success(e,null,!0),directory_list.component.refresh(),BackToList()})).fail((function(){Coker.sweet.error("錯誤",t,null,!0)}))}function AddUpAdvertise(e,t){const i=co.Form.getJson($(AdvertiseForms).attr("id"));co.Advertise.AddUp(i).done((t=>{const i=function(){Coker.sweet.success(e,null,!0),directoryDatailList.component.refresh(),location.hash=`Advertise_${DirectoryId}`};if(void 0!==$ad_type.data("file").File||3==$ad_type.val())switch(parseInt($ad_type.val())){case 1:case 2:var n;(n=new FormData).append("files",$ad_type.data("file").File),n.append("type",10),n.append("sid",t.message),n.append("serno",500),co.File.Upload(n).done((function(){i()}));break;case 3:var a=$(".btn_preview").prev().val(),o=a.substr(a.indexOf("v=")+2);$ad_type.data("file",o),void 0!==t.message&&co.File.UploadYTLink({Id:void 0===$ad_type.data("fileid")?0:$ad_type.data("fileid"),SId:t.message,File:$ad_type.data("file"),Type:10,SerNo:500}).done((function(){i()}));break;default:i()}else i()}))}function MoveToContent(){$(DirectoryForms).removeClass("was-validated"),$("#pages>.card,#TopLine").addClass("d-none"),$("#DirectoryContent").removeClass("d-none")}function BackToList(){$("#pages>.card,#TopLine").addClass("d-none"),$("#DirectoryList").removeClass("d-none"),DirectoryId=0,DirectoryType="n",window.location.hash=""}function MoveToItemList(){const e=window.location.hash.replace("#","").split("_");$("#pages>.card,#TopLine").addClass("d-none"),$("#DirectoryItemps").removeClass("d-none");if(0==$(`#DirectoryItemps>.${e[0].toLowerCase()}`).removeClass("d-none").length)BackToList();else if(e.length>1&&!isNaN(e[1]))if(DirectoryId=parseInt(e[1]),"Advertise"===(DirectoryType=e[0]))$(AdvertiseForms).removeClass("was-validated"),$("#InputDate").val(""),$("#InputDate").attr("disabled","disabled"),directoryDatailList.component.refresh();else BackToList()}function MoveToItemAdvertise(){const e=window.location.hash.replace("#","").split("_");if($("#pages>.card,#TopLine").addClass("d-none"),$AdvertiseTags.TagDataClear(),FileTypeInit(),$ad_type.data("fileid",0),$ad_type.data("file",""),e.length>2&&!isNaN(e[1])&&!isNaN(e[2])){const t=parseInt(e[2]);if(DirectoryId=parseInt(e[1]),"AdvertiseEditor"===e[0]){const e=$.Deferred();co.Directory.Get(DirectoryId).done((t=>{$("#DirectoryItemps").data("dir",t),e.resolve()})),t>0?co.Advertise.GetDataOne(t).done((function(e){null!=e?(e.startEndDate=0,e.sortCheckbox=1,e.ImageUpload=1,co.File.getAdFile(e.id,10).done((function(t){switch(t=t[0],$ad_type.val(t.fileType),$ad_type.trigger("change"),co.Form.insertData(e,"#AdvertiseForm"),$ad_type.data("fileid",t.id),parseInt($ad_type.val())){case 1:$(".btn_input_pic > span").addClass("d-none"),$(".img_preview").attr("src",t.link),$(".img_preview").attr("alt",t.name),$(".img_preview").removeClass("d-none"),$(".ad_link > input").val(e.link);break;case 2:$(".video_preview").attr("type",t.video_Type),$(".video_preview").attr("src",t.link);break;case 3:$(".ad_link > input").val(t.link),$(".btn_preview").trigger("click")}$AdvertiseTags.TagDataSet(e.tagDatas)}))):BackToList()})):(co.Form.clear("AdvertiseForm"),$("#AdvertiseForm > input[name='id'").val(""),e.promise().done((function(){$AdvertiseTags.TagDataSet($("#DirectoryItemps").data("dir").tagDatas)}))),$("#AdvertiseContent").removeClass("d-none")}else BackToList()}}function editAdvertiseButtonClicked(e){window.location.hash=`AdvertiseEditor_${DirectoryId}_${e.row.key}`}function deleteAdvertiseButtonClicked(e){Coker.sweet.confirm("刪除資料","刪除後不可返回","確定刪除","取消",(function(){co.Advertise.Delete(e.row.key).done((function(t){t.success&&e.component.refresh()}))}))}function FileTypeInit(){$(".ad_preview > div").each((function(e){$(this).addClass("d-none")})),$(".ad_preview > .preview").removeClass("d-none"),$(".img_preview").attr("src",""),$(".img_preview").addClass("d-none"),$(".btn_input_pic > span").removeClass("d-none"),$(".ad_preview > .youtube > iframe").attr("src",""),$(".ad_link > input").val(""),$(".ad_link > input").removeAttr("required"),$(".ad_link").addClass("d-none"),$(".ad_link > .checkbox").addClass("d-none"),$(".ad_link > button").addClass("d-none"),$(".video_preview").attr("type",""),$(".video_preview").attr("src","")}function ImageTypeInit(){$(".ad_preview > .preview").addClass("d-none"),$(".ad_preview > .image").removeClass("d-none"),$(".ad_link").removeClass("d-none"),$(".ad_link > input").attr("required","required"),$(".ad_link > input").attr("placeholder","輸入連結網址"),$(".ad_link > .checkbox").removeClass("d-none")}function VideoTypeInit(){$(".ad_preview > .preview").addClass("d-none"),$(".ad_preview > .video").removeClass("d-none")}function YoutubeTypeInit(){$(".ad_preview > .preview").addClass("d-none"),$(".ad_link").removeClass("d-none"),$(".ad_link > input").attr("required","required"),$(".ad_link > input").attr("placeholder","https://www.youtube.com/watch?v="),$(".ad_link > button").removeClass("d-none")}