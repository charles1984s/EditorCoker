var keyId,order_list;let $btn_reSend,$btn_save;var oristate=0,payment="",transactionId="",thirdparty=0;function PageReady(){OrderDataCollapse(),$(window).resize(OrderDataCollapse),ElementInit(),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回訂單列表","資料將不被保存","確定","取消",(function(){history.back()}))})),$btn_reSend.on("click",(function(){co.sweet.confirm("重新發送通知信","是否確認重發訂單通知信?","確定","取消",(function(){co.Order.SendMail(keyId)}))})),$btn_save.on("click",(function(){const e=$(".status_select > option:selected").text();var t=parseInt($(".status_select > option:selected").val());t==oristate||"LINEPay"!=payment&&"支付連"!=payment?updateOrder():[1,5,6].includes(t)||3==thirdparty&&1==oristate||6==oristate?co.sweet.error("訂單狀態錯誤",`不可將狀態變更為【${e}】`):updateOrder()})),co.Order.GetOrderStatusLookup().done((function(e){$(e).each((function(){$order_status.append(`<option value="${this.id}">${this.name}</option>`)}))})),$(".btn_confirm").on("click",(function(){co.sweet.loading(),Coker.ThirdParty.Line.Confirm(keyId).done((function(e){e.success?($(".confirm").addClass("d-none"),$order_status.val(2),OrderStateChange(oristate=4),co.sweet.success("付款程序已完成",(function(){updateOrder(),console.log(e.message)}),!1)):co.sweet.error(e.error,e.message,null,!1)}))})),$(".btn_void").on("click",(function(){co.sweet.confirm("取消授權","確定取消消費者付款授權？","確定","取消",(function(){co.sweet.loading(),Coker.ThirdParty.Line.PayVoid(keyId).done((function(e){e.success?($(".confirm").addClass("d-none"),$order_status.val(4),OrderStateChange(oristate=4),co.sweet.success("已取消付款授權",(function(){updateOrder(),console.log(e.message)}),!1)):co.sweet.error(e.error,e.message,null,!1)}))}))})),$(".btn_recheck").on("click",(function(){co.sweet.loading(),Coker.ThirdParty.CheckPaymentStatus(keyId,thirdparty).done((function(e){if(e.success){var t=e.message.split(",")[0];t!=oristate?($(".btn_recheck").addClass("d-none"),$order_status.val(t),OrderStateChange(oristate=t),co.sweet.success(`訂單狀態變更為【${$order_status.find("option:selected").text()}】`,(function(){updateOrder(),console.log(e.message.split(",")[1])}))):Swal.fire({title:"訂單狀態",text:"訂單狀態未更動。"})}}))})),$(".btn_refund").on("click",(function(){co.sweet.confirm("退回貨款","確定退回貨款?","確定","取消",(function(){co.sweet.loading(),Coker.ThirdParty.PayRefund(payment,keyId).done((function(e){e.success?($(".btn_refund").addClass("d-none"),$order_status.val(4),OrderStateChange(oristate=4),updateOrder()):co.sweet.error(e.error,e.message,null,!1)}))}))})),$(".btn_checkrefund").on("click",(function(){co.sweet.loading(),Coker.ThirdParty.CheckRefund(payment,transactionId).done((function(e){e.success?Swal.fire({title:"退款狀態查詢",text:e.message}):co.sweet.error("錯誤",e.message,null,!1)}))})),$(".btn_failReason").on("click",(function(){co.sweet.loading(),Coker.ThirdParty.CheckPaymentStatus(keyId,thirdparty).done((function(e){Swal.fire({title:`Code: ${e.error}`,text:e.message.split(",")[1]})}))})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function updateOrder(){co.Order.UpdateStatus({Id:keyId,Status:$order_status.val(),Memo:$memo_block.val()}).done((function(e){if(e.success)switch(co.sweet.success("儲存成功"),parseInt($order_status.val())){case 4:case 5:$order_status.prop("disabled",!0)}else co.sweet.error("儲存失敗",e.error)}))}function ElementInit(){$order_number=$(".order_number"),$order_date=$(".order_date"),$order_subtotal=$(".order_subtotal"),$order_freight=$(".order_freight"),$order_total=$(".order_total"),$order_payment=$(".order_payment"),$order_shipping=$(".order_shipping"),$order_status=$(".status_select"),$order_notes=$(".order_notes"),$memo_block=$(".memo_block"),$recipient_name=$(".recipient_name"),$recipient_cellphone=$(".recipient_cellphone"),$recipient_telphone=$(".recipient_telphone"),$recipient_address=$(".recipient_address"),$orderer_name=$(".orderer_name"),$orderer_cellphone=$(".orderer_cellphone"),$orderer_telphone=$(".orderer_telphone"),$orderer_address=$(".orderer_address"),$btn_reSend=$(".btn_reSend"),$btn_save=$(".btn_save")}function FormDataClear(){keyId=0,$order_number.text(""),$order_date.text(""),$order_subtotal.text(""),$order_freight.text(""),$order_total.text(""),$order_payment.text(""),$order_shipping.text(""),$order_status.val(0),$order_status.prop("disabled",!1),$order_notes.text(""),$(".confirm").addClass("d-none"),$(".btn_recheck").addClass("d-none"),$(".btn_refund").addClass("d-none"),$(".btn_checkrefund").addClass("d-none"),$(".btn_failReason").addClass("d-none"),$recipient_name.text(""),$recipient_cellphone.text(""),$recipient_telphone.text(""),$recipient_address.text(""),$orderer_name.text(""),$orderer_cellphone.text(""),$orderer_telphone.text(""),$orderer_address.text("")}function contentReady(e){order_list=e;var t=new URLSearchParams(window.location.search).get("mid");null!==t&&($("#OrderListDx").dxDataGrid("instance").columnOption("MemberId",{selectedFilterOperation:"=",filterValue:t}),window.history.replaceState(null,"","/OrderManagement")),HashDataEdit()}function onCellPrepared(e){if("data"===e.rowType&&"State"===e.column.dataField){var t=$(e.cellElement);"已付款"==e.value&&t.addClass("text-bg-success")}}function onRowPrepared(e){if("data"===e.rowType){let t=$(e.rowElement);"付款失敗"===e.data.State&&t.addClass("isFail")}}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#",""),t=`${e}`;co.Order.GetDisplay(t).done((function(e){if(e.length>0){HeaderDataInsert(e[0].orderHeader);var t=e[0].orderDetails;$.each(t,(function(e,t){var r=$($("#Template_Purchase_List").html()).clone();r=DataInsert(t,r),$("#OrderDetails > .card-body > .purchase_list").append(r)})),MoveToContent()}else window.location.hash=""})),co.Order.GetHeaderOld(parseInt(e)).done((function(e){null!=e&&(FormDataClear(),keyId=e.id,HeaderDataSet(e))}))}}else BackToList()}function editButtonClicked(e){keyId=e.row.key,window.location.hash=keyId,MoveToContent()}function HeaderDataInsert(e){DataInsert(e,$("#OrderDetails")),DataInsert(e,$("#OrderDetails .card-body > div")),DataInsert(e,$("#OrderDetails .card-body > .purchase_amount")),DataInsert(e,$("#OrderData")),null!=e.ordererId&&($("#OrdererData .btn_orderer_data").css("display","flex"),$("#OrdererData .btn_orderer_data").attr({href:`/MemberManagement/MemberList#${e.ordererId}`,title:`連結至：訂購人(${e.orderer})`}),$("#OrdererData .btn_orderer_data").text(`000000000${e.ordererId}`.substring(e.ordererId.toString().length)))}function HeaderDataSet(e){thirdparty=e.thirdParties,payment=e.payment.indexOf("-")>0?e.payment.substring(0,e.payment.indexOf("-")):e.payment,transactionId=e.transactionId,$order_status.val(e.state),oristate=parseInt(e.state);var t=!1;if([4,5].includes(oristate))$order_status.prop("disabled",!0);else if(7==oristate){var r=new Date;r.setDate(r.getDate()-7),null!=e.completedDate&&new Date(e.completedDate)<r&&($order_status.prop("disabled",!0),t=!0)}null!=e.refundTransactionId?$(".btn_checkrefund").removeClass("d-none"):null==e.transactionId||[1,5,6].includes(oristate)||t?OrderStateChange(oristate):[7,8,10,15].includes(e.paymentCode)||$(".btn_refund").removeClass("d-none"),$order_notes.text(e.remark),$recipient_name.text(e.recipient),$recipient_cellphone.text(e.recipientCellPhone);var n=e.recipientTelePhone.indexOf("-",5);$recipient_telphone.text(e.recipientTelePhone.substr(n+1).length>0?e.recipientTelePhone:e.recipientTelePhone.subtotal(0,n)),$recipient_address.text(e.recipientAddress),$orderer_name.text(e.orderer),$orderer_cellphone.text(e.ordererCellPhone);var a=e.ordererTelePhone.indexOf("-",5);""!=e.ordererTelePhone?$orderer_telphone.text(e.ordererTelePhone.substr(a+1).length>0?e.ordererTelePhone:e.ordererTelePhone.subtotal(0,a)):$orderer_telphone.text("-"),$memo_block.val(e.memo),$("#InvoiceData").find("*").each((function(){var t=$(this);if(void 0!==t.data("key")){var r=t.data("key");switch(r){case"invoiceRecipient":switch(parseInt(e.invoiceRecipient)){case 1:t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.siblings("div").text("同訂購人："),t.text(e.orderer);break;case 2:t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.siblings("div").text("同收件人："),t.text(e.recipient);break;case 3:t.parent("div").hasClass("d-none")||t.parent("div").addClass("d-none")}break;case"invoiceTitle":case"uniformId":null!=e[r]?(t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.text(e[r])):t.parent("div").addClass("d-none");break;case"invoiceAddress":t.text(e[r].replaceAll(" ",""));break;default:t.text(e[r])}}}))}function DataInsert(e,t){return t.find("*").each((function(){var t=$(this),r=t.data("key");if(void 0!==t.data("key"))switch(t.data("key")){case"id":t.text(`000000000${e[r]}`.substring(e[r].toString().length));break;case"imagePath":t.attr({src:e[r],alt:`${e.title}的圖片`});break;case"spec":var n=e.s1Title+(""==e.s2Title?"":` ${e.s2Title}`);t.text(n);break;default:"invoiceRecipient"!=t.data("key")&&t.text(e[r])}})),t}function MoveToContent(){$("#OrderList").addClass("d-none"),$("#OrderContent").removeClass("d-none"),$btn_reSend.removeClass("d-none"),$btn_save.removeClass("d-none")}function BackToList(){$("#OrderList").removeClass("d-none"),$("#OrderContent").addClass("d-none"),$btn_reSend.addClass("d-none"),$btn_save.addClass("d-none"),window.location.hash="",$("#OrderDetails > .card-body > .purchase_list > .purchase_item").each((function(){$(this).remove()}))}function OrderDataCollapse(){$this_body=$("body > .wrapper > .content-area > .content-wrapper"),$OrderDetails=$("#OrderDetails"),$OrderData=$("#OrderData"),$this_body.width()>=1024?($("#Btn_Side_Collapse").addClass("d-none"),$OrderDetails.removeClass("col-12"),$OrderData.addClass("col-3"),$OrderData.removeClass("offcanvas offcanvas-end visible"),$OrderData.css("visibility","")):($("#Btn_Side_Collapse").removeClass("d-none"),$OrderDetails.addClass("col-12"),$OrderData.addClass("offcanvas offcanvas-end visible"),$OrderData.removeClass("col-3"))}function OrderStateChange(e){switch($(".confirm").addClass("d-none"),$(".btn_recheck").addClass("d-none"),$(".btn_refund").addClass("d-none"),$(".btn_checkrefund").addClass("d-none"),$(".btn_failReason").addClass("d-none"),parseInt(e)){case 1:3==thirdparty&&$(".btn_recheck").removeClass("d-none");break;case 5:1!=thirdparty&&$(".btn_failReason").removeClass("d-none");break;case 6:switch(payment){case"LINEPay":$(".confirm").removeClass("d-none");break;case"支付連":$(".btn_recheck").removeClass("d-none")}}}