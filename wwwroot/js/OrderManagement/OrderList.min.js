var keyId,order_list;let $btn_reSend,$btn_save;var oristate=0,payment="";function PageReady(){OrderDataCollapse(),$(window).resize(OrderDataCollapse),ElementInit(),$(".btn_back").on("click",(function(){Coker.sweet.confirm("返回訂單列表","資料將不被保存","確定","取消",(function(){history.back()}))})),$btn_reSend.on("click",(function(){co.sweet.confirm("重新發送通知信","是否確認重發訂單通知信?","確定","取消",(function(){co.Order.SendMail(keyId)}))})),$btn_save.on("click",(function(){const e=$(".status_select > option:selected").text();var t=parseInt($(".status_select > option:selected").val());if(t!=oristate)switch(payment){case"LINEPay":6==t?co.sweet.error("訂單狀態錯誤",`不可將狀態變更為【${e}】`):6==oristate?[1,4,5].includes(t)?co.sweet.confirm("變更訂單狀態",`訂單已授權付款，是否確認將訂單狀態變更為【${e}】並取消授權？`,"確定","取消",(function(){Coker.ThirdParty.Line.PayVoid(keyId).done((function(e){e.success?(updateOrder(),console.log(e.message)):co.sweet.error(e.error,e.message,null,!1)}))})):2==t?co.sweet.confirm("變更訂單狀態",`是否確認將訂單狀態變更為【${e}】並執行付款流程？`,"確定","取消",(function(){$(".btn_confirm").trigger("click")})):co.sweet.error("訂單狀態錯誤","訂單已授權付款，如要變更訂單狀態，請先完成付款程序。"):[2,3,7].includes(oristate)&&[1,4,5].includes(t)?co.sweet.confirm("變更訂單狀態",`訂單已完成付款，是否確認將訂單狀態變更為【${e}】？`,"確定","取消",(function(){co.sweet.confirm("變更訂單狀態","是否退回貨款?","確定","取消",(function(){Coker.ThirdParty.PayRefund("LinePay",keyId).done((function(e){e.success?(updateOrder(),console.log(e.message)):co.sweet.error(e.error,e.message,null,!1)}))}),updateOrder)})):updateOrder();break;case"支付連":6==t?co.sweet.error("訂單狀態錯誤",`不可將狀態變更為【${e}】`):6==oristate?co.sweet.error("訂單狀態錯誤","訂單交易等待中不可更改，請先確認付款狀態"):[2,3,7].includes(oristate)&&[1,4,5].includes(t)?co.sweet.confirm("變更訂單狀態",`訂單已完成付款，是否確認將訂單狀態變更為【${e}】？`,"確定","取消",(function(){co.sweet.confirm("變更訂單狀態","是否退回貨款?","確定","取消",(function(){Coker.ThirdParty.PayRefund("PCHomePay",keyId).done((function(e){e.success?(updateOrder(),console.log(e.message)):co.sweet.error(e.error,e.message,null,!1)}))}),updateOrder)})):updateOrder();break;default:co.sweet.confirm("變更訂單狀態",`是否確認將訂單狀態變更為【${e}】?`,"確定","取消",(function(){updateOrder()}))}else updateOrder()})),co.Order.GetOrderStatusLookup().done((function(e){$(e).each((function(){$order_status.append(`<option value="${this.id}">${this.name}</option>`)}))})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3)}function updateOrder(){co.Order.UpdateStatus({Id:keyId,Status:$order_status.val(),Memo:$memo_block.val()}).done((function(e){if(e.success)switch(co.sweet.success("儲存成功"),parseInt($order_status.val())){case 4:case 5:$order_status.prop("disabled",!0)}else co.sweet.error("儲存失敗",e.error)}))}function ElementInit(){$order_number=$(".order_number"),$order_date=$(".order_date"),$order_subtotal=$(".order_subtotal"),$order_freight=$(".order_freight"),$order_total=$(".order_total"),$order_payment=$(".order_payment"),$order_shipping=$(".order_shipping"),$order_status=$(".status_select"),$order_notes=$(".order_notes"),$memo_block=$(".memo_block"),$recipient_name=$(".recipient_name"),$recipient_cellphone=$(".recipient_cellphone"),$recipient_telphone=$(".recipient_telphone"),$recipient_address=$(".recipient_address"),$orderer_name=$(".orderer_name"),$orderer_cellphone=$(".orderer_cellphone"),$orderer_telphone=$(".orderer_telphone"),$orderer_address=$(".orderer_address"),$btn_reSend=$(".btn_reSend"),$btn_save=$(".btn_save")}function FormDataClear(){keyId=0,$order_number.text(""),$order_date.text(""),$order_subtotal.text(""),$order_freight.text(""),$order_total.text(""),$order_payment.text(""),$order_shipping.text(""),$order_status.val(0),$order_status.prop("disabled",!1),$order_notes.text(""),$(".btn_failReason").hasClass("d-none")||$(".btn_failReason").addClass("d-none"),$(".btn_confirm").hasClass("d-none")||$(".btn_confirm").addClass("d-none"),$(".btn_recheck").hasClass("d-none")||$(".btn_recheck").addClass("d-none"),$recipient_name.text(""),$recipient_cellphone.text(""),$recipient_telphone.text(""),$recipient_address.text(""),$orderer_name.text(""),$orderer_cellphone.text(""),$orderer_telphone.text(""),$orderer_address.text("")}function contentReady(e){order_list=e,HashDataEdit()}function hashChange(e){e?(HashDataEdit(),e.preventDefault()):console.log("HashChange錯誤")}function HashDataEdit(){if(FormDataClear(),""!=window.location.hash){if(window.currentHash!=window.location.hash){var e=window.location.hash.replace("#","");co.Order.GetHeaderOld(parseInt(e)).done((function(e){null!=e?(keyId=e.id,HeaderDataSet(e),co.Order.GetDetails(keyId).done((function(e){for(var t=0;t<e.length;t++)DetailsDataSet(e[t]);MoveToContent()}))):window.location.hash=""}))}}else BackToList()}function editButtonClicked(e){keyId=e.row.key,window.location.hash=keyId,MoveToContent()}function HeaderDataSet(e){switch(payment=e.payment.indexOf("-")?e.payment.substring(0,e.payment.indexOf("-")):e.payment,$order_number.text(("000000000"+e.id).substr(e.id.length)),$order_date.text(e.creationTime),$order_subtotal.text(`$${e.subtotal.toLocaleString("en-US")}`),$order_freight.text(`$${e.freight.toLocaleString("en-US")}`),$order_total.text(`$${e.total.toLocaleString("en-US")}`),$order_payment.text(e.payment),$order_shipping.text(e.shipping),$order_status.val(e.state),oristate=e.state,parseInt(e.state)){case 4:$order_status.prop("disabled",!0);break;case 5:if($order_status.prop("disabled",!0),"LINEPay"===payment)$(".btn_failReason").hasClass("d-none")&&$(".btn_failReason").removeClass("d-none");break;case 6:switch(payment){case"LINEPay":$(".btn_confirm").hasClass("d-none")&&$(".btn_confirm").removeClass("d-none");break;case"支付連":$(".btn_recheck").hasClass("d-none")&&$(".btn_recheck").removeClass("d-none")}}$order_notes.text(e.remark),$recipient_name.text(e.recipient),$recipient_cellphone.text(e.recipientCellPhone);var t=e.recipientTelephone.indexOf("-",5);$recipient_telphone.text(e.recipientTelephone.substr(t+1).length>0?e.recipientTelephone:e.recipientTelephone.subtotal(0,t)),$recipient_address.text(e.recipientAddress),$orderer_name.text(e.orderer),$orderer_cellphone.text(e.ordererCellPhone);var r=e.ordererTelephone.indexOf("-",5);switch($orderer_telphone.text(e.ordererTelephone.substr(r+1).length>0?e.ordererTelephone:e.ordererTelephone.subtotal(0,r)),$memo_block.val(e.memo),$("#InvoiceData").find("*").each((function(){var t=$(this);if(void 0!==t.data("key")){var r=t.data("key");switch(r){case"invoiceRecipient":switch(parseInt(e.invoiceRecipient)){case 1:t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.siblings("div").text("同訂購人："),t.text(e.orderer);break;case 2:t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.siblings("div").text("同收件人："),t.text(e.recipient);break;case 3:t.parent("div").hasClass("d-none")||t.parent("div").addClass("d-none")}break;case"invoiceTitle":case"uniformId":null!=e[r]&&(t.parent("div").hasClass("d-none")&&t.parent("div").removeClass("d-none"),t.text(e[r]));break;case"invoiceAddress":t.text(e[r].replaceAll(" ",""));break;default:t.text(e[r])}}})),payment){case"LINEPay":$(".btn_failReason").on("click",(function(){Coker.ThirdParty.Line.CheckPaymentStatus(keyId).done((function(e){Swal.fire({title:`Code: ${e.returnCode}`,text:e.returnMessage})}))})),$(".btn_confirm").on("click",(function(){Coker.ThirdParty.Line.Confirm(keyId).done((function(e){e.success?co.sweet.success("付款程序已完成",(function(){location.reload()}),!1):co.sweet.error(e.error,e.message,null,!1)}))}));break;case"支付連":$(".btn_recheck").on("click",(function(){co.sweet.loading(),Coker.ThirdParty.PChomePay.CheckStatus(keyId).done((function(e){0!=e.order_state&&e.order_state!=e.state&&($order_status.val(e.order_state),$(".btn_recheck").hasClass("d-none")||$(".btn_recheck").addClass("d-none"),oristate=e.order_state,co.sweet.success(`訂單狀態變更為【${$order_status.find("option:selected").text()}】`))}))}))}}function DetailsDataSet(e){var t=$($("#Templat_Purchase_List").html()).clone(),r=t.find(".pro_image"),n=t.find(".pro_name"),o=t.find(".pro_specification"),a=t.find(".pro_instructions"),s=t.find(".pro_unit"),d=t.find(".pro_quantity"),i=t.find(".pro_subtotal");r.attr("src",e.imagePath),n.text(e.title),o.text(e.s1Title+" "+e.s2Title),a.text(e.description),s.text(e.price.toLocaleString("en-US")),d.text(e.quantity),i.text(`$${(e.price*e.quantity).toLocaleString("en-US")}`),$("#OrderDetails > .card-body > .purchase_list").append(t)}function MoveToContent(){$("#OrderList").addClass("d-none"),$("#OrderContent").removeClass("d-none"),$btn_reSend.removeClass("d-none"),$btn_save.removeClass("d-none")}function BackToList(){$("#OrderList").removeClass("d-none"),$("#OrderContent").addClass("d-none"),$btn_reSend.addClass("d-none"),$btn_save.addClass("d-none"),window.location.hash="",$("#OrderDetails > .card-body > .purchase_list > .purchase_item").each((function(){$(this).remove()}))}function OrderDataCollapse(){$this_body=$("body > .wrapper > .content-area > .content-wrapper"),$OrderDetails=$("#OrderDetails"),$OrderData=$("#OrderData"),$this_body.width()>=1024?($("#Btn_Side_Collapse").addClass("d-none"),$OrderDetails.removeClass("col-12"),$OrderData.addClass("col-3"),$OrderData.removeClass("offcanvas offcanvas-end visible"),$OrderData.css("visibility","")):($("#Btn_Side_Collapse").removeClass("d-none"),$OrderDetails.addClass("col-12"),$OrderData.addClass("offcanvas offcanvas-end visible"),$OrderData.removeClass("col-3"))}